<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.07.19 -->
        <title>uxsim.uxsim - UXsim: Traffic Simulation in Python v1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111714220-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-111714220-1');
</script>
  
</head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">UXsim: Traffic Simulation in Python v1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">UXsim: Traffic Simulation in Python v1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorial.html">Tutorial and Examples</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorial and Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_01en.html">Step-by-step Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_10en_traffic_signal_tutorial.html">Tutorial on Traffic Signal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_02en.html">Advanced example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_03en_pytorch.html">Signal control by PyTorch (DQN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_04en_OpenStreetMap.html">Network data import from OpenStreetMap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_06en_taxi_or_shared_mobility.html">Taxi / Shared mobility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_09en_dynamic_traffic_assignment.html">Dynamic Traffic Assignments: DUO, DUE, DSO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/demo_notebook_08en_chicago.html">Huge-scale simulation using Chicago-Sketch dataset</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mechanism.html">Simulation Mechanism: Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mechanism_detailed.html">Simulation Mechanism: Details</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tech_ref.html">Technical Reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Technical Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.World.html">uxsim.World</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.Node.html">uxsim.Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.Link.html">uxsim.Link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.Vehicle.html">uxsim.Vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.RouteChoice.html">uxsim.RouteChoice</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.analyzer.Analyzer.html">uxsim.analyzer.Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.Route.html">uxsim.Route</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.TaxiHandler.TripRequest.html">uxsim.TaxiHandler.TripRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.TaxiHandler.TaxiHandler.html">uxsim.TaxiHandler.TaxiHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.TaxiHandler.TaxiHandler_nearest.html">uxsim.TaxiHandler.TaxiHandler_nearest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.OSMImporter.OSMImporter.html">uxsim.OSMImporter.OSMImporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.DTAsolvers.SolverDUE.html">uxsim.DTAsolvers.SolverDUE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.DTAsolvers.SolverDSO_GA.html">uxsim.DTAsolvers.SolverDSO_GA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.ResultGUIViewer.ResultGUIViewer.html">uxsim.ResultGUIViewer.ResultGUIViewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.uxsim.html">uxsim.uxsim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.utils.html">uxsim.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.scenario_reader_writer.html">uxsim.scenario_reader_writer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.ResultGUIViewer.ResultGUIViewer.html">uxsim.ResultGUIViewer.ResultGUIViewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.TaxiHandler.TaxiHandler.html">uxsim.TaxiHandler.TaxiHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/uxsim.Utilities.Utilities.html">uxsim.Utilities.Utilities</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for uxsim.uxsim</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">UXsim: Macroscopic/mesoscopic traffic flow simulator in a network.</span>
<span class="sd">This `uxsim.py` is the core of UXsim. It summarizes the classes and methods that are essential for the simulation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span><span class="o">,</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">string</span><span class="o">,</span><span class="w"> </span><span class="nn">warnings</span><span class="o">,</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span> <span class="k">as</span> <span class="n">ddict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.csgraph</span><span class="w"> </span><span class="kn">import</span> <span class="n">dijkstra</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dill</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pickle</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.scenario_reader_writer</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="Node">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Node">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Node in a network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Node.__init__">
<a class="viewcode-back" href="../../_autosummary/uxsim.Node.html#uxsim.Node.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">signal_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">signal_offset_old</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flow_capacity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">number_of_lanes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a node</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which the node belongs.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the node.</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate of the node (for visualization purposes).</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate of the node (for visualization purposes).</span>
<span class="sd">        signal : list of int, optional</span>
<span class="sd">            A list representing the signal at the node. Default is [0], representing no signal.</span>
<span class="sd">            If a signal is present, the list contains the green times for each group.</span>
<span class="sd">            For example, `signal`=[60, 10, 50, 5] means that this signal has 4 phases, and green time for the 1st group is 60 s.</span>
<span class="sd">        signal_offset : float, optional</span>
<span class="sd">            The offset of the signal. Default is 0.</span>
<span class="sd">        signal_offset_old : float, optional</span>
<span class="sd">            The old parameter used to set offset of the signal prior to v1.8.1. This is the opposite of the usual definition of offset. Default is None, meaning it is `signal_offset` is used.</span>
<span class="sd">        flow_capacity : float, optional</span>
<span class="sd">            The maximum flow capacity of the node. Default is None, meaning infinite capacity.</span>
<span class="sd">        auto_rename : bool, optional</span>
<span class="sd">            Whether to automatically rename the node if the name is already used. Default is False.</span>
<span class="sd">        number_of_lanes : int, optional</span>
<span class="sd">            The number of lanes that can be green simultaniously at the node. Default is None.</span>
<span class="sd">        attribute : any, optional</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        user_attribute : any, optional</span>
<span class="sd">            Additional (meta) attributes defined by users. Same functionality to `attribute`, but with more understandable name.</span>
<span class="sd">        user_function : func, optinal</span>
<span class="sd">            User-defined custom function that is automatically called when timestep is incremented (more precisely, when `update()` is called). It takes only one argument: the Node object itself. Example: The following code prints the current number of incoming vehicles to the node at each timestep. If user_function=None (default), no functions will be executed.</span>
<span class="sd">            &gt;&gt;&gt; def user_function(node):</span>
<span class="sd">            &gt;&gt;&gt;     print(len(node.incoming_vehicles))</span>
<span class="sd">            &gt;&gt;&gt; W = World(...)</span>
<span class="sd">            &gt;&gt;&gt; W.addNode(&quot;node&quot;, 0, 0, user_function=user_function)</span>
<span class="sd">            &gt;&gt;&gt; ... #define your scenario</span>
<span class="sd">            &gt;&gt;&gt; W.exec_simulation()</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        signal_phase : int</span>
<span class="sd">            The phase of current signal. Links that have the same `signal_group` have a green signal.</span>
<span class="sd">        signal_t : float</span>
<span class="sd">            The elapsed time since the current signal phase started. When it is larger than `Link.signal[Link.signal_phase]`, the phase changes to the next one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#node position (for visualization)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">s</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="c1">#custom attibutes</span>
        <span class="n">s</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="n">s</span><span class="o">.</span><span class="n">user_attribute</span> <span class="o">=</span> <span class="n">user_attribute</span>
        <span class="n">s</span><span class="o">.</span><span class="n">user_function</span> <span class="o">=</span> <span class="n">user_function</span>
        
        <span class="c1">#incoming/outgoing links</span>
        <span class="n">s</span><span class="o">.</span><span class="n">inlinks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">outlinks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1">#request for inter-link transfer (demand for node model)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#vertical queue for vehicle generation</span>
        <span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

        <span class="c1">#signal settings</span>
        <span class="c1">#If this node does not have a signal, set `signal=[0]`</span>
        <span class="c1">#If this node has a signal, set `signal=[green time for group0, green time for group1. ...]`</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cycle_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_offset</span> <span class="o">=</span> <span class="n">signal_offset</span>
        <span class="k">if</span> <span class="n">signal_offset_old</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cycle_length</span><span class="o">-</span><span class="n">signal_offset_old</span>
        
        <span class="n">offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cycle_length</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">signal_offset</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">=</span> <span class="n">offset</span>
                    <span class="k">break</span>
                <span class="n">offset</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">s</span><span class="o">.</span><span class="n">signal_log</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#flow capacity (macroscopic/continious representation for signal)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_lanes_automatically_determined</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">=</span> <span class="n">number_of_lanes</span>
        <span class="k">if</span> <span class="n">flow_capacity</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">=</span> <span class="n">flow_capacity</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">=</span> <span class="n">flow_capacity</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
            <span class="k">if</span> <span class="n">number_of_lanes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">=</span> <span class="n">number_of_lanes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">flow_capacity</span><span class="o">/</span><span class="mf">0.8</span><span class="p">)</span> <span class="c1">#the number of lanes is determined by assuming 0.8 veh/s capacity per lane</span>
                <span class="n">s</span><span class="o">.</span><span class="n">flag_lanes_automatically_determined</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">=</span> <span class="mf">10e10</span>
            <span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">s</span><span class="o">.</span><span class="n">auto_rename</span> <span class="o">=</span> <span class="n">auto_rename</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">auto_rename</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_renamed&quot;</span><span class="o">+</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node name </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already used by another node. Please specify a unique name.&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Node </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Node.signal_control">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Node.signal_control">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">signal_control</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the signal timings for a traffic signal node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span><span class="p">]:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_t</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cycle_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>

        <span class="n">s</span><span class="o">.</span><span class="n">signal_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="Node.flow_capacity_update">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Node.flow_capacity_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">flow_capacity_update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        flow capacity updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">=</span> <span class="mf">10e10</span></div>


<div class="viewcode-block" id="Node.generate">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Node.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Departs vehicles from the waiting queue.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If there are vehicles in the generation queue of the node, this method attempts to depart a vehicle to one of the outgoing links.</span>
<span class="sd">        The choice of the outgoing link is based on the vehicle&#39;s route preference for each link. Once a vehicle is departed, it is removed from the generation queue, added to the list of vehicles on the chosen link, and its state is set to &quot;run&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outlinks0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlinks0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outlinks0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                    
                    <span class="n">veh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1">#consider the link preferences</span>
                    <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">):</span>
                        <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">links_avoid</span><span class="p">):</span>
                        <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">links_avoid</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    
                    <span class="n">preference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outlinks</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">hard_deterministic_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">preference</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">outlink</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">outlinks</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">preference</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">preference</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">outlink</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outlink</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">preference</span><span class="p">,</span> <span class="n">outlinks</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="ow">or</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">outlink</span><span class="o">.</span><span class="n">delta_per_lane</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
                        <span class="c1">#</span>
                        <span class="n">veh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">generation_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

                        <span class="n">veh</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;run&quot;</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">outlink</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">u</span> <span class="c1">#</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span><span class="p">[</span><span class="n">veh</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">veh</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lane</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">veh</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">:</span>
                            <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">]</span>
                            <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="n">veh</span>
                            <span class="k">assert</span> <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">lane</span> <span class="o">==</span> <span class="n">veh</span><span class="o">.</span><span class="n">lane</span>

                        <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>
                        <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles_enter_log</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh</span>

                        <span class="n">outlink</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

                        <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span></div>


<div class="viewcode-block" id="Node.transfer">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Node.transfer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transfer</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers vehicles between links at the node.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method handles the transfer of vehicles from one link to another at the node.</span>
<span class="sd">        A vehicle is eligible for transfer if:</span>
<span class="sd">        </span>
<span class="sd">        - The next link it intends to move to has space.</span>
<span class="sd">        - The vehicle has the right signal phase to proceed.</span>
<span class="sd">        - The current link has enough capacity to allow the vehicle to exit.</span>
<span class="sd">        - The node capacity is not exceeded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outlinks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">outlink_candidates</span> <span class="o">=</span> <span class="p">{</span><span class="n">veh</span><span class="o">.</span><span class="n">route_next_link</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">outlink</span> <span class="ow">in</span> <span class="n">outlink_candidates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">):</span><span class="c1">#</span>
                <span class="n">outlinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outlink</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">hard_deterministic_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">outlink</span> <span class="ow">in</span> <span class="n">outlinks</span><span class="p">:</span> 
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="ow">or</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">outlink</span><span class="o">.</span><span class="n">delta_per_lane</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="n">vehs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">veh</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> 
                    <span class="k">if</span> <span class="n">veh</span> <span class="o">==</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="c1">#</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">==</span> <span class="n">outlink</span> <span class="ow">and</span> <span class="c1">#</span>
                    <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal_phase</span> <span class="ow">in</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">signal_group</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="c1">#</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="p">]</span> 
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vehs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">merge_priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">merge_priority</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">vehs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">merge_priorities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">merge_priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merge_priorities</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">hard_deterministic_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">veh</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">vehs</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">merge_priorities</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">merge_priorities</span><span class="p">))</span> <span class="c1">#</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">veh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">merge_priorities</span><span class="p">,</span> <span class="n">vehs</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="n">inlink</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span>

                <span class="c1">#</span>
                <span class="n">inlink</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="n">outlink</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="n">inlink</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">):]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">-</span> <span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="c1">#</span>

                <span class="n">veh</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

                <span class="n">inlink</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="n">outlink</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_remain</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>

                <span class="c1">#</span>
                <span class="n">inlink</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles_enter_log</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">outlink</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">follower</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">follower</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lane</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">:</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="n">outlink</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">]</span>
                    <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="n">veh</span>
                    <span class="k">assert</span> <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">lane</span> <span class="o">==</span> <span class="n">veh</span><span class="o">.</span><span class="n">lane</span>

                <span class="c1">#</span>
                <span class="n">x_next</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">move_remain</span><span class="o">*</span><span class="n">outlink</span><span class="o">.</span><span class="n">u</span><span class="o">/</span><span class="n">inlink</span><span class="o">.</span><span class="n">u</span>
                <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x_cong</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">x_old</span> <span class="o">-</span> <span class="n">veh</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">delta_per_lane</span><span class="o">*</span><span class="n">veh</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
                    <span class="k">if</span> <span class="n">x_cong</span> <span class="o">&lt;</span> <span class="n">veh</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
                        <span class="n">x_cong</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">x</span>
                    <span class="k">if</span> <span class="n">x_next</span> <span class="o">&gt;</span> <span class="n">x_cong</span><span class="p">:</span>
                        <span class="n">x_next</span> <span class="o">=</span> <span class="n">x_cong</span>

                <span class="k">if</span> <span class="n">x_next</span> <span class="o">&gt;=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">outlink</span><span class="o">.</span><span class="n">length</span>
                    
                <span class="n">veh</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_next</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="o">+=</span> <span class="n">veh</span><span class="o">.</span><span class="n">x</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">move_remain</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flag_waiting_for_trip_end</span><span class="p">:</span>
                    <span class="n">inlink</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end_trip</span><span class="p">()</span>

                <span class="n">outlink</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">inlinks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flag_waiting_for_trip_end</span><span class="p">:</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end_trip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="n">s</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Node.update">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Node.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make necessary updates when the timestep is incremented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_control</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flow_capacity_update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">user_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">user_function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Link">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Link</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Link in a network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Link.__init__">
<a class="viewcode-back" href="../../_autosummary/uxsim.Link.html#uxsim.Link.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">jam_density</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">jam_density_per_lane</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">number_of_lanes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">merge_priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">signal_group</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">capacity_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">capacity_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eular_dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a link</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which the link belongs.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the link.</span>
<span class="sd">        start_node : str | Node</span>
<span class="sd">            The name of the start node of the link.</span>
<span class="sd">        end_node : str | Node</span>
<span class="sd">            The name of the end node of the link.</span>
<span class="sd">        length : float</span>
<span class="sd">            The length of the link.</span>
<span class="sd">        free_flow_speed : float, optional</span>
<span class="sd">            The free flow speed on the link, default is 20.</span>
<span class="sd">        jam_density : float, optional  </span>
<span class="sd">            The jam density on the link, default is 0.2. If jam_density_per_lane is specified, this value is ignored.</span>
<span class="sd">        jam_density_per_lane : float, optional</span>
<span class="sd">            The jam density per lane on the link. If specified, it overrides the jam_density value.</span>
<span class="sd">        number_of_lanes : int, optional</span>
<span class="sd">            The number of lanes on the link, default is 1.</span>
<span class="sd">        merge_priority : float, optional</span>
<span class="sd">            The priority of the link when merging at the downstream node, default is 1.</span>
<span class="sd">        signal_group : int or list, optional</span>
<span class="sd">            The signal group(s) to which the link belongs, default is 0. If `signal_group` is int, say 0, it becomes green if `end_node.signal_phase` is 0. If `signal_group` is list, say [0,1], it becomes green if the `end_node.signal_phase` is 0 or 1.</span>
<span class="sd">        capacity_out : float, optional</span>
<span class="sd">            The capacity out of the link, default is calculated based on other parameters.</span>
<span class="sd">        capacity_in : float, optional</span>
<span class="sd">            The capacity into the link, default is calculated based on other parameters.</span>
<span class="sd">        eular_dx : float, optional</span>
<span class="sd">            The space aggregation size for link traffic state computation, default is 1/10 of link length or free flow distance per simulation step, whichever is larger.</span>
<span class="sd">        attribute : any, optional</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        user_attribute : any, optional</span>
<span class="sd">            Additional (meta) attributes defined by users. Same functionality to `attribute`, but with more understandable name.</span>
<span class="sd">        user_function : func, optinal</span>
<span class="sd">            User-defined custom function that is automatically called when timestep is incremented (more precisely, when `update()` is called). It takes only one argument: the Link object itself. Example: The following code prints the current number of vehicles on the link at each timestep. If user_function=None (default), no functions will be executed.</span>
<span class="sd">            &gt;&gt;&gt; def user_function(link):</span>
<span class="sd">            &gt;&gt;&gt;     print(len(link.vehicles))</span>
<span class="sd">            &gt;&gt;&gt; W = World(...)</span>
<span class="sd">            &gt;&gt;&gt; W.addLink(&quot;link&quot;, &quot;node1&quot;, &quot;node2, 1000, user_function=user_function)</span>
<span class="sd">            &gt;&gt;&gt; ... #define your scenario</span>
<span class="sd">            &gt;&gt;&gt; W.exec_simulation()</span>
<span class="sd">        auto_rename : bool, optional</span>
<span class="sd">            Whether to automatically rename the link if the name is already used. Default is False (raise an exception).</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : float</span>
<span class="sd">            Average speed of traffic on the link.</span>
<span class="sd">        density : float</span>
<span class="sd">            Density of traffic on the link.</span>
<span class="sd">        flow : float</span>
<span class="sd">            Flow of traffic on the link.</span>
<span class="sd">        num_vehicles : float</span>
<span class="sd">            Number of vehicles on the link.</span>
<span class="sd">        num_vehicles_queue : float</span>
<span class="sd">            Number of slow vehicles (due to congestion) on the link.</span>
<span class="sd">        free_flow_speed : float</span>
<span class="sd">            Free flow speed of the link.</span>
<span class="sd">        jam_density : float</span>
<span class="sd">            Jam density of the link.</span>
<span class="sd">        capacity_out : float</span>
<span class="sd">            Capacity for outflow from the link.</span>
<span class="sd">        capacity_in : float</span>
<span class="sd">            Capacity for inflow to the link.</span>
<span class="sd">        merge_priority : float</span>
<span class="sd">            The priority of the link when merging at the downstream node.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Traffic Flow Model:</span>

<span class="sd">        - The link model follows a multi-lane, single-pipe approach where FIFO is guaranteed per link and no lane changing occurs.</span>
<span class="sd">        - Fundamental diagram parameters such as free_flow_speed, jam_density (or jam_density_per_lane), and number_of_lanes determine the link&#39;s flow characteristics. Reaction time of drivers `REACTION_TIME` is a grobal parameter.</span>
<span class="sd">        - Real-time link status for external reference is maintained with attributes `speed`, `density`, `flow`, `num_vehicles`, and `num_vehicles_queue`.</span>

<span class="sd">        Traffic Flow Model Parameters:</span>

<span class="sd">        - Their definition is illustrated as https://toruseo.jp/UXsim/docs/_images/fundamental_diagram.png</span>
<span class="sd">        - If you are not familiar to the traffic flow theory, it is recommended that you adjust only `free_flow_speed` and `number_of_lanes` for the traffic flow model parameters, leaving the other parameters at their default values.</span>

<span class="sd">        Capacity and Bottlenecks:</span>

<span class="sd">        - The `capacity_out` and `capacity_in` parameters set the outflow and inflow capacities of the link. If not provided, the capacities are unlimited.</span>
<span class="sd">        - These capacities can represent bottlenecks at the beginning or end of the link.</span>

<span class="sd">        Connection to Node Model:</span>

<span class="sd">        - At the downstream end of a sending link, vehicles in all lanes have the right to be sent out, but FIFO order is maintained.</span>
<span class="sd">        - At the upstream end of a receiving link, all lanes can accept vehicles.</span>

<span class="sd">        Parameter Adjustments:</span>

<span class="sd">        - Some traffic flow model parameters like `free_flow_speed`, `jam_density`, `capacity_out`, `capacity_in`, and `merge_priority` can be altered during simulation to reflect changing conditions.</span>
<span class="sd">            </span>
<span class="sd">        Details on Multi-lane model:</span>

<span class="sd">        - Link model:</span>
<span class="sd">            - Multiple lanes with single-pipe model. FIFO is guaranteed per link. No lane changing.</span>
<span class="sd">            - Links have a `lanes` attribute representing the number of lanes. </span>
<span class="sd">            - Each vehicle has a `lane` attribute.</span>
<span class="sd">            - Each vehicle follows the leader vehicle in the same lane, i.e., the vehicle `lanes` steps ahead on the link.</span>
<span class="sd">        - Node model: </span>
<span class="sd">            - Sending links:</span>
<span class="sd">                - Vehicles in all lanes at the downstream end of the link have the right to be sent out.</span>
<span class="sd">                - However, to ensure link FIFO, vehicles are tried to be sent out in the order they entered the link. If a vehicle cannot be accepted, the outflow from that link stops.</span>
<span class="sd">            - Receiving links:  </span>
<span class="sd">                - All lanes at the upstream end of the link can accept vehicles.</span>

<span class="sd">        Details on Fundamental diagram parameters (+: input, ++: alternative input):</span>

<span class="sd">        - free_flow_speed (m/s)+</span>
<span class="sd">        - jam_density (veh/m/LINK)+</span>
<span class="sd">        - jam_density_per_lane (veh/m/lane)++</span>
<span class="sd">        - lanes, number_of_lane (lane)+</span>
<span class="sd">        - tau: y-intercept of link FD (s/veh*LINK)</span>
<span class="sd">        - REACTION_TIME, World.reaction_time (s/veh*lane) </span>
<span class="sd">        - w (m/s)</span>
<span class="sd">        - capacity (veh/s/LINK)</span>
<span class="sd">        - capacity_per_lane (veh/s/lane)</span>
<span class="sd">        - delta: minimum spacing (m/veh*LINK)</span>
<span class="sd">        - delta_per_lane: minimum spacing in lane (m/veh*lane) </span>
<span class="sd">        - q_star: capacity (veh/s/LINK)</span>
<span class="sd">        - k_star: critical density (veh/s/LINK)</span>
<span class="sd">        - capacity_in, capacity_out: bottleneck capacity at beginning/end of link (veh/s/LINK)+</span>
<span class="sd">        - Node.flow_capacity: node flow capacity (veh/s/LINK-LIKE)+</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">start_node</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">start_node</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">end_node</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">end_node</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_of_lanes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">!=</span> <span class="n">number_of_lanes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number_of_lanes must be an integer. Got </span><span class="si">{</span><span class="n">number_of_lanes</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        

        <span class="c1">#:per link</span>

        <span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">free_flow_speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">jam_density</span>
        <span class="k">if</span> <span class="n">jam_density</span> <span class="o">==</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">jam_density_per_lane</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">jam_density_per_lane</span><span class="o">*</span><span class="n">number_of_lanes</span>
        <span class="k">if</span> <span class="n">jam_density</span> <span class="o">!=</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">jam_density_per_lane</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">jam_density_per_lane</span><span class="o">*</span><span class="n">number_of_lanes</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">: jam_density is ignored because jam_density_per_lane is set.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">REACTION_TIME</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span>
        <span class="n">s</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">tau</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="n">s</span><span class="o">.</span><span class="n">delta_per_lane</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="c1">#m/veh for each lane. used for car-following model per lane</span>
        <span class="n">s</span><span class="o">.</span><span class="n">q_star</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span>   <span class="c1">#flow capacity</span>
        <span class="n">s</span><span class="o">.</span><span class="n">k_star</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">u</span>   <span class="c1">#critical density</span>
        
        <span class="n">s</span><span class="o">.</span><span class="n">free_flow_speed</span> <span class="o">=</span> <span class="n">free_flow_speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">jam_density</span> <span class="o">=</span> <span class="n">jam_density</span>
        <span class="n">s</span><span class="o">.</span><span class="n">jam_density_per_lane</span> <span class="o">=</span> <span class="n">jam_density_per_lane</span>


        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">merge_priority</span> <span class="o">=</span> <span class="n">merge_priority</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

        <span class="c1">#t: Vehicle</span>
        <span class="n">s</span><span class="o">.</span><span class="n">vehicles_enter_log</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_choice_penalty</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">signal_group</span> <span class="o">=</span> <span class="n">signal_group</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">signal_group</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">signal_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">signal_group</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span> <span class="o">=</span> <span class="n">capacity_out</span>
        <span class="k">if</span> <span class="n">capacity_out</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span><span class="o">*</span><span class="mi">2</span>
            <span class="c1">#todo_later: capacity_out2</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">=</span> <span class="n">capacity_in</span>
        <span class="k">if</span> <span class="n">capacity_in</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity</span><span class="o">*</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

        <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">s</span><span class="o">.</span><span class="n">auto_rename</span> <span class="o">=</span> <span class="n">auto_rename</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">auto_rename</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_renamed&quot;</span><span class="o">+</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Link name </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already used by another link. Please specify a unique name.&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">s</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">outlinks</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">s</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">inlinks</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

        <span class="n">s</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="n">s</span><span class="o">.</span><span class="n">user_attribute</span> <span class="o">=</span> <span class="n">user_attribute</span>
        <span class="n">s</span><span class="o">.</span><span class="n">user_function</span> <span class="o">=</span> <span class="n">user_function</span>


        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">tss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">xss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">s</span><span class="o">.</span><span class="n">eular_dx</span> <span class="o">=</span> <span class="n">eular_dx</span>
        <span class="k">if</span> <span class="n">eular_dx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">10</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span></div>



    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Link </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Link.init_after_tmax_fix">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.init_after_tmax_fix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_after_tmax_fix</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initalization before simulation execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Euler</span>
        <span class="n">s</span><span class="o">.</span><span class="n">edie_dt</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span>
        <span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span>
        <span class="n">s</span><span class="o">.</span><span class="n">k_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">edie_dt</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span><span class="p">)])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">q_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">tn_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dn_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">k_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">an</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">edie_dt</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">edie_dx</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">)])</span></div>


<div class="viewcode-block" id="Link.update">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make necessary updates when the timestep is incremented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">in_out_flow_constraint</span><span class="p">()</span>

        <span class="n">s</span><span class="o">.</span><span class="n">set_traveltime_instant</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">user_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">user_function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="Link.in_out_flow_constraint">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.in_out_flow_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_out_flow_constraint</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link capacity updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_out</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">number_of_lanes</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">capacity_in</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_out_remain</span> <span class="o">=</span> <span class="mf">10e10</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity_in_remain</span> <span class="o">=</span> <span class="mf">10e10</span></div>


<div class="viewcode-block" id="Link.set_traveltime_instant">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.set_traveltime_instant">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_traveltime_instant</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute instantaneous travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">%</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">instantaneous_TT_timestep_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="Link.arrival_count">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.arrival_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">arrival_count</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cumulative vehicle count of arrival to this link on time t</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The cumulative arrival vehicle count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_arrival</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>


<div class="viewcode-block" id="Link.departure_count">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.departure_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">departure_count</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cumulative vehicle count of departure from this link on time t</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The cumulative departure vehicle count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>


<div class="viewcode-block" id="Link.instant_travel_time">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.instant_travel_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">instant_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get instantaneous travel time of this link on time t</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The instantaneous travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>


<div class="viewcode-block" id="Link.actual_travel_time">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Link.actual_travel_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">actual_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get actual travel time of vehicle who enters this link on time t. Note that small error may occur due to fractional processing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The actual travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span></div>


    <span class="c1">#getter/setter</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">speed</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">_speed</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_speed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">density</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">num_vehicles</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">length</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_density</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flow</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">speed</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_flow</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_vehicles</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_vehicles_queue</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">veh</span><span class="o">.</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">vehicles</span><span class="p">])</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">_num_vehicles_queue</span>

    <span class="c1">#Disabled temporally to avoid cirtical bugs related to scenario writer/reader. Instead, change_*() are added</span>
    <span class="c1"># @property</span>
    <span class="c1"># def free_flow_speed(s):</span>
    <span class="c1">#     return s.u</span>

    <span class="c1"># @free_flow_speed.setter</span>
    <span class="c1"># def free_flow_speed(s, new_value):</span>
    <span class="c1">#     if new_value &gt;= 0:</span>
    <span class="c1">#         s.u = new_value</span>
    <span class="c1">#         s.w = 1/s.tau/s.kappa</span>
    <span class="c1">#         s.capacity = s.u*s.w*s.kappa/(s.u+s.w)</span>
    <span class="c1">#         s.delta = 1/s.kappa</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         warnings.warn(f&quot;ignored negative free_flow_speed at {s}&quot;, UserWarning)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def jam_density(s):</span>
    <span class="c1">#     return s.kappa</span>

    <span class="c1"># @jam_density.setter</span>
    <span class="c1"># def jam_density(s, new_value):</span>
    <span class="c1">#     if new_value &gt;= 0:</span>
    <span class="c1">#         s.kappa = new_value</span>
    <span class="c1">#         s.w = 1/s.tau/s.kappa</span>
    <span class="c1">#         s.capacity = s.u*s.w*s.kappa/(s.u+s.w)</span>
    <span class="c1">#         s.delta = 1/s.kappa</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         warnings.warn(f&quot;ignored negative jam_density at {s}&quot;, UserWarning)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">change_free_flow_speed</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">free_flow_speed</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">tau</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ignored negative free_flow_speed at </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">change_jam_density</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">free_jam_density</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">tau</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
            <span class="n">s</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">u</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">kappa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ignored negative jam_density at </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span></div>





<div class="viewcode-block" id="Vehicle">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Vehicle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vehicle or platoon in a network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Vehicle.__init__">
<a class="viewcode-back" href="../../_autosummary/uxsim.Vehicle.html#uxsim.Vehicle.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">departure_time</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_pref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_choice_principle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;single_trip&quot;</span><span class="p">,</span> <span class="n">links_prefer</span><span class="o">=</span><span class="p">[],</span> <span class="n">links_avoid</span><span class="o">=</span><span class="p">[],</span> <span class="n">trip_abort</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">departure_time_is_time_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a vehicle (more precisely, platoon)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which the vehicle belongs.</span>
<span class="sd">        orig : str | Node</span>
<span class="sd">            The origin node.</span>
<span class="sd">        dest : str | Node</span>
<span class="sd">            The destination node.</span>
<span class="sd">        departure_time : int</span>
<span class="sd">            The departure time of the vehicle.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of the vehicle, default is the id of the vehicle.</span>
<span class="sd">        route_pref : dict, optional</span>
<span class="sd">            The preference weights for links, default is 0 for all links.</span>
<span class="sd">        route_choice_principle : str, optional</span>
<span class="sd">            The route choice principle of the vehicle, default is the network&#39;s route choice principle.</span>
<span class="sd">        mode : str, optional</span>
<span class="sd">            The mode of the vehicle. Available options are &quot;single_trip&quot; and &quot;taxi&quot;, default is &quot;single_trip&quot;.</span>
<span class="sd">            &quot;single_trip&quot;: The vehicle makes a single trip from the origin to the destination.</span>
<span class="sd">            &quot;taxi&quot;: The vehicle serves multiple trips by specifying sequence of destinations. The destination list `Vehicle.dest_list` can be dynamically updated externaly.</span>
<span class="sd">        links_prefer : list of str, optional</span>
<span class="sd">            The names of the links the vehicle prefers, default is empty list.</span>
<span class="sd">        links_avoid : list of str, optional</span>
<span class="sd">            The names of the links the vehicle avoids, default is empty list.</span>
<span class="sd">        trip_abort : int, optional</span>
<span class="sd">            Whether to abort the trip if a dead end is reached, default is 1.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        user_attribute : any, optional</span>
<span class="sd">            Additional (meta) attributes defined by users. Same functionality to `attribute`, but with more understandable name.</span>
<span class="sd">        user_function : func, optinal</span>
<span class="sd">            User-defined custom function that is automatically called when timestep is incremented (more precisely, when `update()` is called). It takes only one argument: the Vehicle object itself. Example: The following code prints the current speed of vehicle at each timestep. If user_function=None (default), no functions will be executed.</span>
<span class="sd">            &gt;&gt;&gt; def user_function(veh):</span>
<span class="sd">            &gt;&gt;&gt;     print(veh.speed))</span>
<span class="sd">            &gt;&gt;&gt; W = World(...)</span>
<span class="sd">            &gt;&gt;&gt; ... #define your scenario</span>
<span class="sd">            &gt;&gt;&gt; W.addVehicle(&quot;orig&quot;, &quot;dest&quot;, 100, user_function=user_function)</span>
<span class="sd">            &gt;&gt;&gt; W.exec_simulation()</span>
<span class="sd">        auto_rename : bool, optional</span>
<span class="sd">            Whether to automatically rename the vehicle if the name is already used. Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">departure_time_is_time_step</span><span class="p">:</span><span class="c1">#departure_time -&gt; TODO: </span>
            <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span> <span class="o">=</span> <span class="n">departure_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">departure_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">departure_time_in_second</span> <span class="o">=</span> <span class="n">departure_time</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>  <span class="c1">#TODO: temporal workaround</span>
        <span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link_arrival_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1">#home, wait, runend</span>
        <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;home&quot;</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x_old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s</span><span class="o">.</span><span class="n">follower</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_waiting_for_trip_end</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">move_remain</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1">#</span>

        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">route_choice_principle</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_choice_principle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">=</span> <span class="n">route_choice_principle</span>

        <span class="c1">#private vehicle or taxi</span>
        <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dest_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#dict of events that are triggered when this vehicle reaches a certain node {Node: func}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">node_event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1">#{link.id:}</span>
        <span class="k">if</span> <span class="n">route_pref</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_pref_for_vehs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_pref_for_vehs</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">}</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_pref_for_vehs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">route_pref</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="c1">#these links will be always chosen or not chosen when choosing next link at each node</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links_prefer</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links_avoid</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">trip_abort</span> <span class="o">=</span> <span class="n">trip_abort</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flag_trip_aborted</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#log</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_t</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_state</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_link</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_x</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_s</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_v</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">log_lane</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#</span>
        <span class="n">s</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>

        <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">departure_time</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="s2">&quot;home&quot;</span><span class="p">]]</span> <span class="c1">#route-level log. It records the time and link when the vehicle entered new link</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link_old</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">s</span><span class="o">.</span><span class="n">distance_traveled</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">s</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="n">s</span><span class="o">.</span><span class="n">user_attribute</span> <span class="o">=</span> <span class="n">user_attribute</span>
        <span class="n">s</span><span class="o">.</span><span class="n">user_function</span> <span class="o">=</span> <span class="n">user_function</span>

        <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">auto_rename</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_renamed&quot;</span><span class="o">+</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vehicle name </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already used by another vehicle. Please specify a unique name.&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Vehicle </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">, x=</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">, link=</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Vehicle.update">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the vehicle&#39;s state and position.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method updates the state and position of the vehicle based on its current situation.</span>

<span class="sd">        - If the vehicle is at &quot;home&quot;, it checks if the current time matches its departure time. If so, the vehicle&#39;s state is set to &quot;wait&quot; and it is added to the generation queue of its origin node.</span>
<span class="sd">        - If the vehicle is in the &quot;wait&quot; state, it remains waiting at its departure node.</span>
<span class="sd">        - If the vehicle is in the &quot;run&quot; state, it updates its speed and position. If the vehicle reaches the end of its current link, it either ends its trip if it has reached its destination, or requests a transfer to the next link.</span>
<span class="sd">        - If the vehicle&#39;s state is &quot;end&quot; or &quot;abort&quot;, no further actions are taken.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">record_log</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;home&quot;</span><span class="p">:</span>
            <span class="c1">#depart</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;wait&quot;</span>
                <span class="n">s</span><span class="o">.</span><span class="n">orig</span><span class="o">.</span><span class="n">generation_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;wait&quot;</span><span class="p">:</span>
            <span class="c1">#wait at the vertical queue at the origin node</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_choice_update_gradual</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_pref_update</span><span class="p">()</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
            <span class="c1">#drive within the link</span>
            <span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x_next</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
            <span class="n">s</span><span class="o">.</span><span class="n">x_old</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
            <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span>

            <span class="c1">#at the end of the link</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">node_event</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">node_event</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="p">]()</span>
                
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_choice_update_gradual</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_pref_update</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;single_trip&quot;</span><span class="p">:</span>
                        <span class="c1">#prepare for trip end</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">flag_waiting_for_trip_end</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">end_trip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;taxi&quot;</span><span class="p">:</span>
                        <span class="c1">#proceed to next destination</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dest_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dest_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">dest_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">route_pref_update</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">route_next_link_choice</span><span class="p">()</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">trip_abort</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#prepare for trip abort due to dead end</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">flag_trip_aborted</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">flag_waiting_for_trip_end</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">end_trip</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#request link transfer</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link_choice</span><span class="p">()</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;abort&quot;</span><span class="p">]</span> <span class="p">:</span>
            <span class="c1">#ended the trip</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">user_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">user_function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="Vehicle.end_trip">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.end_trip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">end_trip</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Procedure when the vehicle finishes its trip.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;end&quot;</span>

        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">cum_departure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">traveltime_actual</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link_arrival_time</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">):]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">link_arrival_time</span>  <span class="c1"># todo: </span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">follower</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">follower</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span>  <span class="c1">#TODO: arrival_time</span>
        <span class="n">s</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">departure_time</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">flag_trip_aborted</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span>
            <span class="n">s</span><span class="o">.</span><span class="n">arrival_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">travel_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">s</span><span class="o">.</span><span class="n">record_log</span><span class="p">(</span><span class="n">enforce_log</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">reduce_memory_delete_vehicle_route_pref</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Vehicle.carfollow">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.carfollow">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">carfollow</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drive withing a link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_cong</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">delta_per_lane</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
            <span class="k">if</span> <span class="n">x_cong</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
                <span class="n">x_cong</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">&gt;</span> <span class="n">x_cong</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="n">x_cong</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">move_remain</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span>
            <span class="n">s</span><span class="o">.</span><span class="n">x_next</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">length</span></div>

    
<div class="viewcode-block" id="Vehicle.enforce_route">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.enforce_route">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enforce_route</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">set_avoid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforce the vehicle to use the specified route. The route should connect the origin to the destination. TODO: add consistency check</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        route : List of Link</span>
<span class="sd">            The route for this vehicle.</span>
<span class="sd">        set_avoid : bool</span>
<span class="sd">            If True, the vehicle only travel the links in `route` argument. This is very strict. If the route is not consistent (e.g., the route does not completely connect between the origin and the destination), it will raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">route</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">set_avoid</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">]</span></div>


<div class="viewcode-block" id="Vehicle.route_pref_update">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.route_pref_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">route_pref_update</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the vehicle&#39;s link preferences for route choice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weight : float</span>
<span class="sd">            The weight for updating the link preferences based on the recent travel time.</span>
<span class="sd">            Should be in the range [0, 1], where 0 means the old preferences are fully retained and 1 means the preferences are completely updated. THIS IS DISABLED FOR NOW.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method updates the link preferences used by the vehicle to select its route based on its current understanding of the system.</span>

<span class="sd">        - If the vehicle&#39;s route choice principle is &quot;homogeneous_DUO&quot;, it will update its preferences based on a global, homogenous dynamic user optimization (DUO) model.</span>
<span class="sd">        - If the route choice principle is &quot;heterogeneous_DUO&quot;, it will update its preferences based on a heterogeneous DUO model, considering both its past preferences and the system&#39;s current state. This is imcomplete feature. Not recommended.</span>

<span class="sd">        The updated preferences guide the vehicle&#39;s decisions in subsequent route choices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">==</span> <span class="s2">&quot;homogeneous_DUO&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">==</span> <span class="s2">&quot;heterogeneous_DUO&quot;</span><span class="p">:</span>
            <span class="n">route_pref_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">}</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">next</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">route_pref_new</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#preference</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+</span> <span class="n">weight</span><span class="o">*</span><span class="n">route_pref_new</span><span class="p">[</span><span class="n">l</span><span class="p">]</span></div>


<div class="viewcode-block" id="Vehicle.route_next_link_choice">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.route_next_link_choice">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">route_next_link_choice</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a next link from the current link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="p">:</span>
            <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlinks</span><span class="p">):</span>

                <span class="c1">#if links_prefer is given and available at the node, select only from the links in the list. if links_avoid is given, select links not in the list.</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">):</span>
                    <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span><span class="p">):</span>
                    <span class="n">outlinks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="n">preference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outlinks</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">hard_deterministic_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">preference</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">outlinks</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">preference</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">preference</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">outlinks</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">preference</span><span class="p">,</span> <span class="n">outlinks</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_next_link</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Vehicle.add_dest">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.add_dest">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_dest</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a destination to the vehicle&#39;s destination list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dest : str | Node</span>
<span class="sd">            The destination node to be added.</span>
<span class="sd">        order : int, optional</span>
<span class="sd">            The order of the destination in the list. Default is -1, which appends the destination to the end of the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;taxi&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
                <span class="n">s</span><span class="o">.</span><span class="n">route_pref_update</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">dest_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">dest_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vehicle </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not in taxi mode. Cannot add destination.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Vehicle.set_links_prefer">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.set_links_prefer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_links_prefer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the links the vehicle prefers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list of str</span>
<span class="sd">            The list of link names the vehicle prefers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_prefer</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="Vehicle.set_links_avoid">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.set_links_avoid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_links_avoid</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">links</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the links the vehicle avoids.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list of str</span>
<span class="sd">            The list of link names the vehicle avoids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_avoid</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span></div>


<div class="viewcode-block" id="Vehicle.add_dests">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.add_dests">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_dests</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dests</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add multiple destinations to the vehicle&#39;s destination list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dests : list of str | Node</span>
<span class="sd">            The list of destinations to be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">add_dest</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Vehicle.traveled_route">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.traveled_route">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">traveled_route</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">include_arrival_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_departure_time</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the route this vehicle traveled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_arrival_time : bool</span>
<span class="sd">            If true, return the arrival time to the destination as well.  `-1` means it did not reach the destination.</span>
<span class="sd">        include_departure_time : bool</span>
<span class="sd">            If true, return the departure time from the origin as well. It will be different from the entering time to the first link if there are congestion (i.e., the vehicle need to enter the network). </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Route</span>
<span class="sd">            The route this vehicle traveled.</span>
<span class="sd">        list</span>
<span class="sd">            The time at which the vehicle entered each link. If `include_arrival_time` is true, the last element is the time the vehicle reached the destination. If `include_departure_time` is true, the first element is the time the vehicle departed from the origin. This complexity is actually due to a design failure in the past. These options are added to keep the backward compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># link_old = -1</span>
        <span class="c1"># t = -1</span>
        <span class="c1"># route = []</span>
        <span class="c1"># ts = []</span>
        <span class="c1"># for i, link in enumerate(s.log_link):</span>
        <span class="c1">#     if link_old != link:</span>
        <span class="c1">#         route.append(link)</span>
        <span class="c1">#         ts.append(s.log_t[i])</span>
        <span class="c1">#         link_old = link</span>

        <span class="c1"># return Route(s.W, route[:-1]), ts</span>

        <span class="n">route</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s2">&quot;home&quot;</span> <span class="ow">and</span> <span class="n">include_departure_time</span><span class="p">:</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="n">Link</span><span class="p">:</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        
        <span class="n">log</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_arrival_time</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Route</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">route</span><span class="p">),</span> <span class="n">ts</span></div>


<div class="viewcode-block" id="Vehicle.get_xy_coords">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.get_xy_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_xy_coords</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the x-y coordinates of the vehicle. If t is given, the position at time t is returned based on the logs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : int | float, optional</span>
<span class="sd">            Time in seconds. If it is -1, the latest position is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">vehicle_logging_timestep_interval</span><span class="p">)]</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">log_x</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">vehicle_logging_timestep_interval</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="n">link</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">xx</span><span class="o">/</span><span class="n">link</span><span class="o">.</span><span class="n">length</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">xx</span><span class="o">/</span><span class="n">link</span><span class="o">.</span><span class="n">length</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="Vehicle.record_log">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Vehicle.record_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">record_log</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">enforce_log</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record travel logs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        enforce_log : bool, optional</span>
<span class="sd">            Record log regardless of the logging interval, default is 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">vehicle_logging_timestep_interval</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">vehicle_logging_timestep_interval</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">%</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">vehicle_logging_timestep_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">enforce_log</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
                    <span class="c1"># if s.state == &quot;end&quot; and s.log_t_link[-1][1] != &quot;end&quot;:</span>
                    <span class="c1">#     s.log_t_link.append([t, &quot;end&quot;])</span>

                    <span class="n">s</span><span class="o">.</span><span class="n">log_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_lane</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;wait&quot;</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed</span> <span class="o">+=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if len(s.log_link) == 0 or s.log_link[-1] != s.link:</span>
                    <span class="c1">#     s.log_t_link.append([t, s.link])</span>

                    <span class="n">s</span><span class="o">.</span><span class="n">log_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">log_lane</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lane</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">log_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">leader</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">log_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">average_speed_count</span>
        
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">link_old</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">log_t_link</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">link_old</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">link</span></div>
</div>



<div class="viewcode-block" id="RouteChoice">
<a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RouteChoice</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for computing shortest path for all vehicles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RouteChoice.__init__">
<a class="viewcode-back" href="../../_autosummary/uxsim.RouteChoice.html#uxsim.RouteChoice.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create route choice computation object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : object</span>
<span class="sd">            The world to which this belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="c1">#: adjacency matrix whose cost is link travel cost</span>
        <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="c1">#ij: the shortest path cost (based on the current instantaneous travel time) from node i to j</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="c1">#ij: the node to proceed from i when the destination is j</span>
        <span class="n">s</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="c1">#ij. This is not used anymore</span>
        <span class="n">s</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>

        <span class="n">s</span><span class="o">.</span><span class="n">dist_record</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#homogeneous DUOk1: array[dest,link]==1 if link is on the shortest path to dest</span>
        <span class="c1">#s.route_pref = {k.id: {l:0 for l in s.W.LINKS} for k in s.W.NODES} #old definition, {node_id: {link: preference}. preference of link is 1 if it is on the shortest path to node_id</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">)])</span></div>


<div class="viewcode-block" id="RouteChoice.route_search_all">
<a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice.route_search_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">route_search_all</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">infty</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the current shortest path based on instantaneous travel time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        infty : float</span>
<span class="sd">            value representing infinity.</span>
<span class="sd">        noise : float</span>
<span class="sd">            very small noise to slightly randomize route choice. useful to eliminate strange results at an initial stage of simulation where many routes has identical travel time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="n">adj_mat_link_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">hard_deterministic_mode</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">new_link_tt</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">noise</span><span class="p">)</span> <span class="o">+</span> <span class="n">link</span><span class="o">.</span><span class="n">route_choice_penalty</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_link_tt</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">traveltime_instant</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">link</span><span class="o">.</span><span class="n">route_choice_penalty</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">adj_mat_link_count</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_link_tt</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># if there are multiple links between the same nodes, average the travel time</span>
                <span class="c1"># s.adj_mat_time[i,j] = new_link_tt #if there is only one link between the nodes, this line is fine, but for generality we use the above line</span>
                <span class="n">adj_mat_link_count</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">capacity_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#if the inflow is profibited, travel time is assumed to be infinite</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="c1">#computes the shortest path from *destination* to *origin*, so that the pred_matrix becomes the next_matrix in the original problem. It is simply achieved by tranposing the matrices twice.</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">dijkstra</span><span class="p">(</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">adj_mat_time</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">return_predecessors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">T</span>
        <span class="n">s</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">T</span>

        <span class="n">s</span><span class="o">.</span><span class="n">dist_record</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dist</span></div>


<div class="viewcode-block" id="RouteChoice.homogeneous_DUO_update">
<a class="viewcode-back" href="../../uxsim.html#uxsim.RouteChoice.homogeneous_DUO_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">homogeneous_DUO_update</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update link preference of all homogeneous travelers based on DUO principle.</span>
<span class="sd">        Vectorized by Claude 3.5 Sonnet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">route_choice_update_gradual</span><span class="p">:</span>
            <span class="n">weight0</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">/</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_TIME</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight0</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span>

        <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)</span>
        <span class="n">num_links</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">)</span>

        <span class="c1"># Create a mask for empty preferences</span>
        <span class="n">empty_pref_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">route_pref</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Initialize weight array</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">weight0</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">empty_pref_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Create arrays for start and end nodes of links</span>
        <span class="n">start_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">])</span>
        <span class="n">end_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">])</span>

        <span class="c1"># Create the next_node_mask</span>
        <span class="n">next_node_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">num_links</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
            <span class="n">next_node_mask</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_nodes</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">next</span><span class="p">[</span><span class="n">start_nodes</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>

        <span class="c1"># Update route preferences</span>
        <span class="c1"># In-place scaling of all elements</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">weights</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

        <span class="c1"># In-place addition of weights where next_node_mask is True</span>
        <span class="n">s</span><span class="o">.</span><span class="n">route_pref</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">next_node_mask</span></div>
</div>



<div class="viewcode-block" id="World">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">World</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    World (i.e., simulation environment). A World object is consistently referred to as `W` in this code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="World.__init__">
<a class="viewcode-back" href="../../_autosummary/uxsim.uxsim.World.html#uxsim.World.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">deltan</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">reaction_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">duo_update_time</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">duo_update_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">duo_noise</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">route_choice_principle</span><span class="o">=</span><span class="s2">&quot;homogeneous_DUO&quot;</span><span class="p">,</span> <span class="n">route_choice_update_gradual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">instantaneous_TT_timestep_interval</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                 <span class="n">eular_dt</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">eular_dx</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                 <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">print_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_mode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_progress_deltat</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> 
                 <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">vehicle_logging_timestep_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">reduce_memory_delete_vehicle_route_pref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">hard_deterministic_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">meta_data</span><span class="o">=</span><span class="p">{},</span> <span class="n">user_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a World.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of the world, default is an empty string.</span>
<span class="sd">        deltan : int, optional</span>
<span class="sd">            The platoon size, default is 5 vehicles.</span>
<span class="sd">        reaction_time : float, optional</span>
<span class="sd">            The reaction time, default is 1 second. This is also related to simulation time step width.</span>
<span class="sd">        duo_update_time : float, optional</span>
<span class="sd">            The time interval for route choice update, default is 600 seconds.</span>
<span class="sd">        duo_update_weight : float, optional</span>
<span class="sd">            The update weight for route choice, default is 0.5.</span>
<span class="sd">        duo_noise : float, optional</span>
<span class="sd">            The noise in route choice, default is 0.01.</span>
<span class="sd">        route_choice_update_gradual : bool, optional</span>
<span class="sd">            Whether to update route choice ratio gradually or not. True is recommended. Default is False for backward compatibility.</span>
<span class="sd">        eular_dt : float, optional</span>
<span class="sd">            The time aggregation size for eularian traffic state computation, default is 120.</span>
<span class="sd">        random_seed : int or None, optional</span>
<span class="sd">            The random seed, default is None.</span>
<span class="sd">        print_mode : int, optional</span>
<span class="sd">            The print mode, whether print the simulation progress or not. Default is 1 (enabled).</span>
<span class="sd">        save_mode : int, optional</span>
<span class="sd">            The save mode,. whether save the simulation results or not.  Default is 1 (enabled).</span>
<span class="sd">        show_mode : int, optional</span>
<span class="sd">            The show mode, whether show the matplotlib visualization results or not. Default is 0 (disabled).</span>
<span class="sd">        route_choice_principle : str, optional</span>
<span class="sd">            The route choice principle, default is &quot;homogeneous_DUO&quot;.</span>
<span class="sd">        show_progress : int, optional</span>
<span class="sd">            Whether show network progress, default is 1 (enabled).</span>
<span class="sd">        show_progress_deltat : float, optional</span>
<span class="sd">            The time interval for showing network progress, default is 600 seconds.</span>
<span class="sd">        tmax : float or None, optional</span>
<span class="sd">            The simulation duration, default is None (automatically determined).</span>
<span class="sd">        vehicle_logging_timestep_interval : int, optional</span>
<span class="sd">            The interval for logging vehicle data, default is 1. Logging is off if set to -1.</span>
<span class="sd">            Setting large intervel (2 or more) or turn off the logging makes the simulation significantly faster in large-scale scenarios without loosing simulation internal accuracy, but outputed vehicle trajecotry and other related data will become inaccurate.</span>
<span class="sd">        instantaneous_TT_timestep_interval : int, optional</span>
<span class="sd">            The interval for computing instantaneous travel time of each link. Default is 5.</span>
<span class="sd">            If it is longer than the DUO update timestep interval, it is substituted by DUO update timestep interval to maintain reasonable route choice behavior.</span>
<span class="sd">        hard_deterministic_mode : bool, optional</span>
<span class="sd">            If True, the simulation will not use any random variables. At a merging node, a link with higher merge_priority will be always prioritized, and vehicles always choose the shortest path. This may be useful for analysis that need strict predictability. Be aware that the simulation results will be significantly different from ones with `hard_deterministic_mode=False`.</span>
<span class="sd">        reduce_memory_delete_vehicle_route_pref : bool, optional</span>
<span class="sd">            If True, the simulation will delete the route preference of vehicles after its ends. This is useful when the route preference is not needed after the simulation ends.</span>
<span class="sd">        meta_data : dict, optinal</span>
<span class="sd">            Meta data for simulation scenario. Can store arbitrary data, such as licences and simulation explanation.</span>
<span class="sd">        user_attribute : any, optinal</span>
<span class="sd">            Optinonal meta attributes that can be freely defined by a user.</span>
<span class="sd">        user_function : func, optinal</span>
<span class="sd">            User-defined custom function that is automatically called when timestep is incremented (more precisely, just before timesptep is incremented). It takes only one argument: the World object itself. Example: The following code prints the current simulation time at each timestep. If user_function=None (default), no functions will be executed.</span>
<span class="sd">            &gt;&gt;&gt; def user_function(W):</span>
<span class="sd">            &gt;&gt;&gt;     print(W.TIME)</span>
<span class="sd">            &gt;&gt;&gt; W = World(user_function=user_function)</span>
<span class="sd">            &gt;&gt;&gt; ... #define your scenario</span>
<span class="sd">            &gt;&gt;&gt; W.exec_simulation()</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        A World object must be defined firstly to initiate simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## parameter setting</span>
        
        <span class="n">W</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>

        <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="n">tmax</span>   <span class="c1">#simulation time (s)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span> <span class="o">=</span> <span class="n">deltan</span>         <span class="c1">#platoon size (veh)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">REACTION_TIME</span> <span class="o">=</span> <span class="n">reaction_time</span>         <span class="c1">#reaction time = simulation time step size (s)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_TIME</span> <span class="o">=</span> <span class="n">duo_update_time</span>     <span class="c1">#time interval for route choice update (s)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span> <span class="o">=</span> <span class="n">duo_update_weight</span>    <span class="c1">#weight for route choice update</span>
        <span class="n">W</span><span class="o">.</span><span class="n">DUO_NOISE</span> <span class="o">=</span> <span class="n">duo_noise</span>    <span class="c1">#very small noise for route choice to avoid singular results</span>
        <span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span> <span class="o">=</span> <span class="n">eular_dt</span>     <span class="c1">#time discretization size for Eular-type data (aggregated traffic state)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">REACTION_TIME</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span>
        <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_TIME</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span> <span class="c1">#this unit is timestep</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">## data storage</span>
        <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>            <span class="c1">#home, wait, run, end</span>
        <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>     <span class="c1">#home, wait, run</span>
        <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>    <span class="c1">#run</span>
        <span class="n">W</span><span class="o">.</span><span class="n">NODES</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#map from name to node object</span>
        <span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">W</span><span class="o">.</span><span class="n">vehicle_logging_timestep_interval</span> <span class="o">=</span> <span class="n">vehicle_logging_timestep_interval</span>

        <span class="n">W</span><span class="o">.</span><span class="n">route_choice_principle</span> <span class="o">=</span> <span class="n">route_choice_principle</span>

        <span class="n">W</span><span class="o">.</span><span class="n">route_choice_update_gradual</span> <span class="o">=</span> <span class="n">route_choice_update_gradual</span>

        <span class="n">W</span><span class="o">.</span><span class="n">instantaneous_TT_timestep_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">instantaneous_TT_timestep_interval</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">&lt;</span> <span class="n">W</span><span class="o">.</span><span class="n">instantaneous_TT_timestep_interval</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">instantaneous_TT_timestep_interval</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span>

        <span class="n">W</span><span class="o">.</span><span class="n">route_pref_for_vehs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## progress print setting</span>
        <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="n">W</span><span class="o">.</span><span class="n">show_progress_deltat_timestep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">show_progress_deltat</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>

        <span class="c1">## memory setting</span>
        <span class="n">W</span><span class="o">.</span><span class="n">reduce_memory_delete_vehicle_route_pref</span> <span class="o">=</span> <span class="n">reduce_memory_delete_vehicle_route_pref</span>

        <span class="c1">## system setting</span>
        <span class="n">W</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">W</span><span class="o">.</span><span class="n">hard_deterministic_mode</span> <span class="o">=</span> <span class="n">hard_deterministic_mode</span>

        <span class="n">W</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">meta_data</span>
        <span class="n">W</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">demand_info</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">W</span><span class="o">.</span><span class="n">world_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="o">=</span> <span class="n">print_mode</span>
        <span class="k">if</span> <span class="n">print_mode</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="nb">print</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">noprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">noprint</span>
        <span class="n">W</span><span class="o">.</span><span class="n">save_mode</span> <span class="o">=</span> <span class="n">save_mode</span>
        <span class="n">W</span><span class="o">.</span><span class="n">show_mode</span> <span class="o">=</span> <span class="n">show_mode</span>

        <span class="n">W</span><span class="o">.</span><span class="n">user_attribute</span> <span class="o">=</span> <span class="n">user_attribute</span>
        <span class="n">W</span><span class="o">.</span><span class="n">user_function</span> <span class="o">=</span> <span class="n">user_function</span></div>


<div class="viewcode-block" id="World.addNode">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.addNode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">addNode</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a node to world</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the node.</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate of the node (for visualization purposes).</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate of the node (for visualization purposes).</span>
<span class="sd">        signal : list of int, optional</span>
<span class="sd">            A list representing the signal at the node. Default is [0], representing no signal.</span>
<span class="sd">            If a signal is present, the list contains the green times for each group.</span>
<span class="sd">            For example, `signal`=[60, 10, 50, 5] means that this signal has 4 phases, and green time for the 1st group is 60 s.</span>
<span class="sd">        signal_offset : float, optional</span>
<span class="sd">            The offset of the signal. Default is 0.</span>
<span class="sd">        flow_capacity : float, optional</span>
<span class="sd">            The maximum flow capacity of the node. Default is None, meaning infinite capacity.</span>
<span class="sd">        auto_rename : bool, optional</span>
<span class="sd">            Whether to automatically rename the node if the name is already used. Default is False.</span>
<span class="sd">        number_of_lanes : int, optional</span>
<span class="sd">            The number of lanes that can be green simultaniously at the node. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            the added Node object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function acts as a wrapper for creating a Node object and adding it to the network.</span>
<span class="sd">        It passes all given arguments and keyword arguments to the Node class initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.addLink">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.addLink">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">addLink</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a link to world</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the link.</span>
<span class="sd">        start_node : str | Node</span>
<span class="sd">            The name of the start node of the link.</span>
<span class="sd">        end_node : str | Node</span>
<span class="sd">            The name of the end node of the link.</span>
<span class="sd">        length : float</span>
<span class="sd">            The length of the link.</span>
<span class="sd">        free_flow_speed : float, optional</span>
<span class="sd">            The free flow speed on the link, default is 20.</span>
<span class="sd">        jam_density : float, optional  </span>
<span class="sd">            The jam density on the link, default is 0.2. If jam_density_per_lane is specified, this value is ignored.</span>
<span class="sd">        jam_density_per_lane : float, optional</span>
<span class="sd">            The jam density per lane on the link. If specified, it overrides the jam_density value.</span>
<span class="sd">        number_of_lanes : int, optional</span>
<span class="sd">            The number of lanes on the link, default is 1.</span>
<span class="sd">        merge_priority : float, optional</span>
<span class="sd">            The priority of the link when merging at the downstream node, default is 1.</span>
<span class="sd">        signal_group : int or list, optional</span>
<span class="sd">            The signal group(s) to which the link belongs, default is 0. If `signal_group` is int, say 0, it becomes green if `end_node.signal_phase` is 0. If `signal_group` is list, say [0,1], it becomes green if the `end_node.signal_phase` is 0 or 1.</span>
<span class="sd">        capacity_out : float, optional</span>
<span class="sd">            The capacity out of the link, default is calculated based on other parameters.</span>
<span class="sd">        capacity_in : float, optional</span>
<span class="sd">            The capacity into the link, default is calculated based on other parameters.</span>
<span class="sd">        eular_dx : float, optional</span>
<span class="sd">            The space aggregation size for link traffic state computation, default is 1/10 of link length or free flow distance per simulation step, whichever is larger.</span>
<span class="sd">        attribute : any, optional</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        auto_rename : bool, optional</span>
<span class="sd">            Whether to automatically rename the link if the name is already used. Default is False (raise an exception).</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            the added Link object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function acts as a wrapper for creating a Link object and adding it to the network.</span>
<span class="sd">        It passes all given arguments and keyword arguments to the Link class initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Link</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.addVehicle">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.addVehicle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">addVehicle</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a vehicle to world</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orig : str | Node</span>
<span class="sd">            The origin node.</span>
<span class="sd">        dest : str | Node</span>
<span class="sd">            The destination node.</span>
<span class="sd">        departure_time : int</span>
<span class="sd">            The departure time of the vehicle.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of the vehicle, default is the id of the vehicle.</span>
<span class="sd">        route_pref : dict, optional</span>
<span class="sd">            The preference weights for links, default is 0 for all links.</span>
<span class="sd">        route_choice_principle : str, optional</span>
<span class="sd">            The route choice principle of the vehicle, default is the network&#39;s route choice principle.</span>
<span class="sd">        mode : str, optional</span>
<span class="sd">            The mode of the vehicle. Available options are &quot;single_trip&quot; and &quot;taxi&quot;, default is &quot;single_trip&quot;.</span>
<span class="sd">            &quot;single_trip&quot;: The vehicle makes a single trip from the origin to the destination.</span>
<span class="sd">            &quot;taxi&quot;: The vehicle serves multiple trips by specifying sequence of destinations. The destination list `Vehicle.dest_list` can be dynamically updated externaly.</span>
<span class="sd">        links_prefer : list of str, optional</span>
<span class="sd">            The names of the links the vehicle prefers, default is empty list.</span>
<span class="sd">        links_avoid : list of str, optional</span>
<span class="sd">            The names of the links the vehicle avoids, default is empty list.</span>
<span class="sd">        trip_abort : int, optional</span>
<span class="sd">            Whether to abort the trip if a dead end is reached, default is 1.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        auto_rename : bool, optional</span>
<span class="sd">            Whether to automatically rename the vehicle if the name is already used. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            the added Vehicle object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function acts as a wrapper for creating a Vehicle object and adding it to the network.</span>
<span class="sd">        It passes all given arguments and keyword arguments to the Vehicle class initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Vehicle</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.adddemand">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand">[docs]</a>
    <span class="nd">@demand_info_record</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adddemand</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orig : str | Node</span>
<span class="sd">            The name or object of the origin node.</span>
<span class="sd">        dest : str | Node</span>
<span class="sd">            The name or object of the destination node.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">t_end</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t_start</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t_end</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">+=</span> <span class="n">flow</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
            <span class="k">while</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">departure_time_is_time_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">attribute</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">-=</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span></div>


        

<div class="viewcode-block" id="World.adddemand_point2point">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_point2point">[docs]</a>
    <span class="nd">@demand_info_record</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adddemand_point2point</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span> <span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand using coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_orig : float</span>
<span class="sd">            The x-coordinate of the origin.</span>
<span class="sd">        y_orig : float</span>
<span class="sd">            The y-coordinate of the origin.</span>
<span class="sd">        x_dest : float</span>
<span class="sd">            The x-coordinate of the destination.</span>
<span class="sd">        y_dest : float</span>
<span class="sd">            The y-coordinate of the destination.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.adddemand_area2area">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_area2area">[docs]</a>
    <span class="nd">@demand_info_record</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adddemand_area2area</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span>  <span class="n">radious_orig</span><span class="p">,</span> <span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">radious_dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand by specifying circular areas. `adddemand_area2area()` is not recommended as it may truncate demand. Consider to use new `adddemand_area2area2()` which is more accurate, smooth, and fast.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_orig : float</span>
<span class="sd">            The x-coordinate of the center of the origin area.</span>
<span class="sd">        y_orig : float</span>
<span class="sd">            The y-coordinate of the center of the origin area.</span>
<span class="sd">        radious_orig : float</span>
<span class="sd">            The radious of the origin area. Note that too large radious may generate too sparse demand that is rounded to zero.</span>
<span class="sd">        x_dest : float</span>
<span class="sd">            The x-coordinate of the center of the destination area.</span>
<span class="sd">        y_dest : float</span>
<span class="sd">            The y-coordinate of the center of the destination area.</span>
<span class="sd">        radious_dest : float</span>
<span class="sd">            The radious of the destination area.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;`adddemand_area2area()` is not recommended as it may truncate demand. Consider to use new `adddemand_area2area2()` which is more accurate, smooth, and fast.&quot;</span><span class="p">,</span>
            <span class="ne">FutureWarning</span>
        <span class="p">)</span>

        <span class="n">origs</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nodes_in_area</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span> <span class="n">radious_orig</span><span class="p">)</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nodes_in_area</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">radious_dest</span><span class="p">)</span>

        <span class="n">origs_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dests_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">origs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">inlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dests_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">origs_new</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">dests_new</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">origs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">flow</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="World.adddemand_nodes2nodes">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_nodes2nodes">[docs]</a>
    <span class="nd">@demand_info_record</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adddemand_nodes2nodes</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">origs</span><span class="p">,</span> <span class="n">dests</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand by specifying origin area (i.e., list of nodes) and destination one. `adddemand_nodes2nodes()` is not recommended as it may truncate demand. Consider to use new `adddemand_nodes2nodes2() which is more accurate, smooth, and fast.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origs : list</span>
<span class="sd">            The list of origin nodes. The items can be Node objects or names of Nodes.</span>
<span class="sd">        dests : list</span>
<span class="sd">            The list of destination nodes. The items can be Node objects or names of Nodes.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;`adddemand_nodes2nodes()` is not recommended as it may truncate demand. Consider to use new `adddemand_nodes2nodes2() which is more accurate, smooth, and fast.`&quot;</span><span class="p">,</span>
            <span class="ne">FutureWarning</span>
        <span class="p">)</span>

        <span class="n">origs_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dests_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">origs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">inlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dests_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">origs_new</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">dests_new</span>
        
        <span class="k">if</span> <span class="n">flow</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.adddemand_area2area2">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_area2area2">[docs]</a>
    <span class="nd">@demand_info_record</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adddemand_area2area2</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span>  <span class="n">radious_orig</span><span class="p">,</span> <span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">radious_dest</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand by specifying circular areas. This is new version of `adddemand_area2area`, more efficient, more smooth, and more accurate. However, it introduces some randomness.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_orig : float</span>
<span class="sd">            The x-coordinate of the center of the origin area.</span>
<span class="sd">        y_orig : float</span>
<span class="sd">            The y-coordinate of the center of the origin area.</span>
<span class="sd">        radious_orig : float</span>
<span class="sd">            The radious of the origin area. Note that too large radious may generate too sparse demand that is rounded to zero.</span>
<span class="sd">        x_dest : float</span>
<span class="sd">            The x-coordinate of the center of the destination area.</span>
<span class="sd">        y_dest : float</span>
<span class="sd">            The y-coordinate of the center of the destination area.</span>
<span class="sd">        radious_dest : float</span>
<span class="sd">            The radious of the destination area.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nodes_in_area</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span> <span class="n">radious_orig</span><span class="p">)</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_nodes_in_area</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">,</span> <span class="n">radious_dest</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flow</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">volume</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">flow</span><span class="o">*</span><span class="p">(</span><span class="n">t_end</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">volume</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span>

        <span class="n">origs_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dests_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">origs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">inlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dests_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">origs_new</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">dests_new</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">origs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">origs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">x_dest</span><span class="p">,</span> <span class="n">y_dest</span><span class="p">))</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        
        <span class="n">os</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">origs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dests</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">dests</span> <span class="k">if</span> <span class="n">dd</span><span class="o">!=</span><span class="n">d</span><span class="p">])</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">attribute</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="World.adddemand_nodes2nodes2">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.adddemand_nodes2nodes2">[docs]</a>
    <span class="nd">@demand_info_record</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adddemand_nodes2nodes2</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">origs</span><span class="p">,</span> <span class="n">dests</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">flow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate vehicles by specifying time-dependent origin-destination demand by specifying origin area (i.e., list of nodes) and destination one. This is new version of `adddemand_nodes2nodes`, more efficient, more smooth, and more accurate. However, it introduces some randomness.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origs : list</span>
<span class="sd">            The list of origin nodes. The items can be Node objects or names of Nodes.</span>
<span class="sd">        dests : list</span>
<span class="sd">            The list of destination nodes. The items can be Node objects or names of Nodes.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            The start time for the demand in seconds.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            The end time for the demand in seconds.</span>
<span class="sd">        flow : float, optional</span>
<span class="sd">            The flow rate from the origin to the destination in vehicles per second.</span>
<span class="sd">        volume: float, optional</span>
<span class="sd">            The demand volume from the origin to the destination. If volume is specified, the flow is ignored.</span>
<span class="sd">        attribute : any, optinonal</span>
<span class="sd">            Additional (meta) attributes defined by users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">flow</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">volume</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">flow</span><span class="o">*</span><span class="p">(</span><span class="n">t_end</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">volume</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">)</span>

        <span class="n">origs_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dests_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">origs</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">outlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">origs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">inlinks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dests_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">origs</span> <span class="o">=</span> <span class="n">origs_new</span>
        <span class="n">dests</span> <span class="o">=</span> <span class="n">dests_new</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        
        <span class="n">os</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">origs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dests</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">dests</span> <span class="k">if</span> <span class="n">dd</span><span class="o">!=</span><span class="n">d</span><span class="p">])</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">attribute</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.finalize_scenario">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.finalize_scenario">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalize_scenario</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalizes the settings and preparations for the simulation scenario execution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tmax : float, optional</span>
<span class="sd">            The maximum simulation time. If not provided, it will be determined based on the departure times of the vehicles.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function automatically called by `exec_simulation()` if it has not been called manually.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">veh</span><span class="o">.</span><span class="n">departure_time</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">:</span>
                        <span class="n">tmax</span> <span class="o">=</span> <span class="n">veh</span><span class="o">.</span><span class="n">departure_time</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>
                <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmax</span><span class="o">//</span><span class="mi">1800</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">1800</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="n">tmax</span>    <span class="c1">#s</span>

        <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#timestep</span>
        <span class="n">W</span><span class="o">.</span><span class="n">TIME</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#s</span>

        <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">Q_AREA</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span><span class="p">)))</span>
        <span class="n">W</span><span class="o">.</span><span class="n">K_AREA</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">EULAR_DT</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">init_after_tmax_fix</span><span class="p">()</span>

        <span class="c1">#generate adjacency matrix</span>
        <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span> <span class="o">=</span> <span class="n">RouteChoice</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">)])</span>
        <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT_LINKS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1">#</span>
        <span class="n">W</span><span class="o">.</span><span class="n">NODE_PAIR_LINKS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1">#</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">start_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">start_node</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">start_node</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">end_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">end_node</span> <span class="o">==</span> <span class="n">link</span><span class="o">.</span><span class="n">end_node</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">W</span><span class="o">.</span><span class="n">ADJ_MAT_LINKS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>
            <span class="n">W</span><span class="o">.</span><span class="n">NODE_PAIR_LINKS</span><span class="p">[</span><span class="n">start_node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">end_node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>

        <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">Analyzer</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

        <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">## </span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print_scenario_stats</span><span class="p">()</span>

        <span class="n">W</span><span class="o">.</span><span class="n">sim_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;simulating...&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.print_scenario_stats">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.print_scenario_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_scenario_stats</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print scenario stats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulation setting:&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulation setting (not finalized):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; scenario name:&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; simulation duration:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of vehicles:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">,</span> <span class="s2">&quot;veh&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; total road length:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">]),</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; time discret. width:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; platoon size:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAN</span><span class="p">,</span> <span class="s2">&quot;veh&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of timesteps:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of timesteps:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of platoons:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of links:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; number of nodes:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; setup time:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">W</span><span class="o">.</span><span class="n">world_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.exec_simulation">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.exec_simulation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">exec_simulation</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">until_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration_t2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the main loop of the simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        until_t : float or None, optional</span>
<span class="sd">            The time until the simulation is to be executed in seconds. </span>
<span class="sd">            If all of `until_t` and `duration_t` and `duration_t2` are None, the simulation is executed until the end. Default is None.</span>
<span class="sd">        duration_t : float or None, optional</span>
<span class="sd">            The duration for which the simulation is to be executed in seconds. Simulation runs `duration_t+1` seconds for a technical reason. Old setting, not recommended.</span>
<span class="sd">            If all of `until_t` and `duration_t` and `duration_t2` are None, the simulation is executed until the end. Default is None. Recommended. </span>
<span class="sd">        duration_t2 : float or None, optional</span>
<span class="sd">            The duration for which the simulation is to be executed in seconds. Simulation runs `duration_t2` seconds.</span>
<span class="sd">            If all of `until_t` and `duration_t` and `duration_t2` are None, the simulation is executed until the end. Default is None. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 1 if the simulation is finished, 0 otherwise.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The function executes the main simulation loop that update links, nodes, and vehicles for each time step.</span>
<span class="sd">        It also performs route search and updates the route preference for vehicles at specified intervals.</span>
<span class="sd">        The simulation is executed until the end time is reached or until the maximum simulation time is exceeded.</span>
<span class="sd">        The nodes, links, and vehicles must be defined before calling this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#finalize the scenario if it has not been done</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">finalize_scenario</span><span class="p">()</span>

        <span class="c1">#determine the simulation time</span>
        <span class="n">start_ts</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">until_t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">until_t</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">duration_t2</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">start_ts</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration_t2</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">duration_t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">start_ts</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration_t</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span>
        <span class="k">if</span> <span class="n">end_ts</span> <span class="o">&gt;</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">:</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span>

        <span class="k">if</span> <span class="n">start_ts</span> <span class="o">==</span> <span class="n">end_ts</span> <span class="o">==</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>
            <span class="n">W</span><span class="o">.</span><span class="n">simulation_terminated</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="c1">#end of simulation</span>
        <span class="k">if</span> <span class="n">end_ts</span> <span class="o">&lt;</span> <span class="n">start_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;exec_simulation error: Simulation duration is not positive. Check until_t or duration_t or duration_t2&quot;</span><span class="p">)</span>

        <span class="c1">#the main loop</span>
        <span class="c1">#print(&quot;preping:&quot;, W.T, start_ts, end_ts, W.check_simulation_ongoing())</span>
        <span class="k">for</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1">#print(&quot;execing:&quot;, W.T, start_ts, end_ts, W.check_simulation_ongoing())</span>
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;      time| # of vehicles| ave speed| computation time&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
                <span class="n">node</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">transfer</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_RUNNING</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">veh</span><span class="o">.</span><span class="n">carfollow</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">route_choice_update_gradual</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">%</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">route_search_all</span><span class="p">(</span><span class="n">noise</span><span class="o">=</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_NOISE</span><span class="p">)</span>
                <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">homogeneous_DUO_update</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">%</span> <span class="n">W</span><span class="o">.</span><span class="n">DELTAT_ROUTE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">route_search_all</span><span class="p">(</span><span class="n">noise</span><span class="o">=</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_NOISE</span><span class="p">)</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">ROUTECHOICE</span><span class="o">.</span><span class="n">homogeneous_DUO_update</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">veh</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">VEHICLES_LIVING</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">veh</span><span class="o">.</span><span class="n">route_pref_update</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">W</span><span class="o">.</span><span class="n">DUO_UPDATE_WEIGHT</span><span class="p">)</span>

            <span class="n">W</span><span class="o">.</span><span class="n">TIME</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">%</span><span class="n">W</span><span class="o">.</span><span class="n">show_progress_deltat_timestep</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">user_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">user_function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1">#print(&quot;break&quot;)</span>
                <span class="k">break</span>

        <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">W</span><span class="o">.</span><span class="n">TIME</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span>

        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="ow">and</span> <span class="n">W</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">show_simulation_progress</span><span class="p">()</span>
            <span class="n">W</span><span class="o">.</span><span class="n">simulation_terminated</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="mi">0</span> <span class="c1">#simulation not yet finished</span></div>


<div class="viewcode-block" id="World.check_simulation_ongoing">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.check_simulation_ongoing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_simulation_ongoing</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the simulation is has not reached its final time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 1 if the simulation is ongoing and has not reached its final time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">finalized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">&lt;=</span> <span class="n">W</span><span class="o">.</span><span class="n">TSIZE</span><span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="World.simulation_terminated">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.simulation_terminated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulation_terminated</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Postprocessing after simulation finished</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">W</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; simulation finished&quot;</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">basic_analysis</span><span class="p">()</span></div>


<div class="viewcode-block" id="World.get_node">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_node</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a Node instance by name or object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node : str or Node object</span>
<span class="sd">            The name of the node or the Node object itself.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Node object</span>
<span class="sd">            The found Node object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Node</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES_NAME_DICT</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&#39; is not Node in this World&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.get_link">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_link">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_link</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a Link instance by name or object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        link : str or Link object</span>
<span class="sd">            The name of the link or the Link object itself.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Link object</span>
<span class="sd">            The found Link object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">link</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Link</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">link</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS_NAME_DICT</span><span class="p">[</span><span class="n">link</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&#39; is not Link in this World&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.get_nearest_node">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_nearest_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_nearest_node</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the nearest node to the given coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate.</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">            The nearest Node object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e10</span>
        <span class="n">nearest_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">:</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="n">nearest_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">nearest_node</span></div>


<div class="viewcode-block" id="World.get_nodes_in_area">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.get_nodes_in_area">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_nodes_in_area</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the nodes in the area defined by the center coordinates and radius.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float</span>
<span class="sd">            The x-coordinate of the center.</span>
<span class="sd">        y : float</span>
<span class="sd">            The y-coordinate of the center.</span>
<span class="sd">        r : float</span>
<span class="sd">            The radius of the area.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of Node objects in the area.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="World.defRoute">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.defRoute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">defRoute</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define Route object for this World.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links (Link object or str)</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the route.</span>
<span class="sd">        trust_input : bool</span>
<span class="sd">            True if you trust the `links` in order to reduce the computation cost by omitting verification.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Route</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="World.load_scenario_from_csv">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.load_scenario_from_csv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_scenario_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname_node</span><span class="p">,</span> <span class="n">fname_link</span><span class="p">,</span> <span class="n">fname_demand</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a scenario from CSV files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname_node : str</span>
<span class="sd">            The file name of the CSV file containing node data.</span>
<span class="sd">        fname_link : str</span>
<span class="sd">            The file name of the CSV file containing link data.</span>
<span class="sd">        fname_demand : str</span>
<span class="sd">            The file name of the CSV file containing demand data.</span>
<span class="sd">        tmax : float or None, optional</span>
<span class="sd">            The maximum simulation time in seconds, default is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">W</span><span class="o">.</span><span class="n">generate_Nodes_from_csv</span><span class="p">(</span><span class="n">fname_node</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">generate_Links_from_csv</span><span class="p">(</span><span class="n">fname_link</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">generate_demand_from_csv</span><span class="p">(</span><span class="n">fname_demand</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">TMAX</span> <span class="o">=</span> <span class="n">tmax</span></div>


<div class="viewcode-block" id="World.generate_Nodes_from_csv">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.generate_Nodes_from_csv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_Nodes_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate nodes in the network from a CSV file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name of the CSV file containing node data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span></div>


<div class="viewcode-block" id="World.generate_Links_from_csv">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.generate_Links_from_csv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_Links_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate links in the network from a CSV file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name of the CSV file containing link data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span>
                    <span class="n">W</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">jam_density</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">merge_priority</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span></div>


<div class="viewcode-block" id="World.generate_demand_from_csv">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.generate_demand_from_csv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_demand_from_csv</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate demand in the network from a CSV file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name of the CSV file containing demand data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;start_t&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">W</span><span class="o">.</span><span class="n">adddemand</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span></div>


<div class="viewcode-block" id="World.save_scenario">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.save_scenario">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_scenario</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">demand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the scenario (Node, Link, demand) to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name to save the scenario.</span>
<span class="sd">        network : bool, optional</span>
<span class="sd">            Whether to save the network (Node, Link) data, default is True.</span>
<span class="sd">        demand : bool, optional</span>
<span class="sd">            Whether to save the demand (adddemand, etc.) data, default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">save_scenario</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">demand</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.load_scenario">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.load_scenario">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_scenario</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">demand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a scenario from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The file name to load the scenario.</span>
<span class="sd">        network : bool, optional</span>
<span class="sd">            Whether to load the network data, default is True.</span>
<span class="sd">        demand : bool, optional</span>
<span class="sd">            Whether to load the demand data, default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">load_scenario</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">demand</span><span class="o">=</span><span class="n">demand</span><span class="p">)</span></div>


<div class="viewcode-block" id="World.on_time">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.on_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_time</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current time step is close to the specified time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : float</span>
<span class="sd">            The specified time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Returns True if the current time step is close to the specified time, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="n">W</span><span class="o">.</span><span class="n">DELTAT</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="World.change_print_mode">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.change_print_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_print_mode</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">print_mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the print mode.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        print_mode : bool</span>
<span class="sd">            The print mode. If True, the print function is enabled. If False, the print function is disabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">W</span><span class="o">.</span><span class="n">print_mode</span> <span class="o">=</span> <span class="n">print_mode</span>
        <span class="k">if</span> <span class="n">print_mode</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="nb">print</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">noprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="n">W</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">noprint</span></div>


<div class="viewcode-block" id="World.show_network">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.show_network">[docs]</a>
    <span class="nd">@catch_exceptions_and_warn</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_network</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">left_handed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">network_font_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">show_id</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the entire transportation network shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : Network</span>
<span class="sd">            The transportation network object.</span>
<span class="sd">        width : int, optional</span>
<span class="sd">            The width of the links in the visualization. Default is 1.</span>
<span class="sd">        left_handed : int, optional</span>
<span class="sd">            Determines the direction of the links. If 1, the links drawn with left-handed traffic rule. If 0, the links are right-handed. Default is 1.</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            The size of the figure in inches. Default is (6, 6).</span>
<span class="sd">        network_font_size : int, optional</span>
<span class="sd">            The font size of the node and link labels. If 0, no labels will be displayed. Default is 10.</span>
<span class="sd">        node_size : int, optional</span>
<span class="sd">            The size of the nodes in the visualization. Default is 6.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_font_for_matplotlib</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">show_id</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">LINKS</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">y</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">y</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">left_handed</span><span class="p">:</span>
                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="o">-</span><span class="n">vx</span><span class="p">,</span> <span class="o">-</span><span class="n">vy</span>
            <span class="c1">#</span>
            <span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">xmid2</span><span class="p">,</span> <span class="n">ymid2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vx</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="n">vy</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">xmid1</span><span class="p">,</span> <span class="n">xmid2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">ymid2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s2">&quot;butt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">network_font_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">show_id</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmid1</span><span class="p">,</span> <span class="n">ymid1</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">network_font_size</span><span class="p">)</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">])</span>
        <span class="n">buffxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">maxy</span><span class="o">-</span><span class="n">miny</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">minx</span><span class="o">-</span><span class="n">buffxy</span><span class="p">,</span> <span class="n">maxx</span><span class="o">+</span><span class="n">buffxy</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">miny</span><span class="o">-</span><span class="n">buffxy</span><span class="p">,</span> <span class="n">maxy</span><span class="o">+</span><span class="n">buffxy</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">save_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out</span><span class="si">{</span><span class="n">W</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/network.png&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">show_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="World.copy">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the World object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        World object</span>
<span class="sd">            The copied World object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">W</span><span class="p">))</span></div>


<div class="viewcode-block" id="World.save">
<a class="viewcode-back" href="../../uxsim.html#uxsim.World.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the World object.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The World object is saved as a pickle file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Route">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Route">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Route</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for a route that store concective links.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Route.__init__">
<a class="viewcode-back" href="../../_autosummary/uxsim.Route.html#uxsim.Route.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">trust_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define a route.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : World</span>
<span class="sd">            The World to which this Route belongs</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links (Link object or str)</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the route.</span>
<span class="sd">        trust_input : bool</span>
<span class="sd">            True if you trust the `links` in order to reduce the computation cost by omitting verification.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; route = Route(W, [&quot;l1&quot;, &quot;l2&quot;, &quot;l3&quot;])</span>
<span class="sd">        ... vehicle_object.links_prefer = route</span>
<span class="sd">        This will enforce the vehicle to travel the route if the route covers the entire links between the OD nodes of the vehicle.</span>

<span class="sd">        &gt;&gt;&gt; route = Route(W, [&quot;l1&quot;, &quot;l2&quot;, &quot;l3&quot;])</span>
<span class="sd">        ... for link in route:</span>
<span class="sd">        ...     print(link)</span>
<span class="sd">        This will print the links in the route.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">trust_input</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">l1</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;route is not defined by concective links: </span><span class="si">{</span><span class="n">links</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">l1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">#todo: interpolation based on shotest path</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">get_link</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="n">s</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">links</span>
        <span class="n">s</span><span class="o">.</span><span class="n">links_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Route </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override `iter()` function. Iterate the links of the route.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override `==` operator. If the links of two route are the same, then the routes are the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Route</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">links</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

<div class="viewcode-block" id="Route.actual_travel_time">
<a class="viewcode-back" href="../../uxsim.html#uxsim.Route.actual_travel_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">actual_travel_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">return_details</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actual travel time for a (hypothetical) vehicle who start traveling this route on time t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>
<span class="sd">        return_details : bool</span>
<span class="sd">            True if you want travel time per link.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The actual travel time.</span>
<span class="sd">        list (if `return_details` is True)</span>
<span class="sd">            List of travel time per link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">link_tt</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">actual_travel_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">link_tt</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">link_tt</span>
            <span class="n">tts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link_tt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tt</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023 Toru Seo
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5cb08e4e"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>