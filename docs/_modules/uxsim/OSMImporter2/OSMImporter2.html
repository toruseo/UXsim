<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.07.19 -->
        <title>uxsim.OSMImporter2.OSMImporter2 - UXsim: Traffic Simulation in Python v1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111714220-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-111714220-1');
</script>
  
</head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">UXsim: Traffic Simulation in Python v1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">UXsim: Traffic Simulation in Python v1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorial.html">Tutorial and Examples</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorial and Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_01en.html">Step-by-step Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_10en_traffic_signal_tutorial.html">Tutorial on Traffic Signal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_02en.html">Advanced example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_03en_pytorch.html">Signal control by PyTorch (DQN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_04en_OpenStreetMap.html">Network data import from OpenStreetMap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_06en_taxi_or_shared_mobility.html">Taxi / Shared mobility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_09en_dynamic_traffic_assignment.html">Dynamic Traffic Assignments: DUO, DUE, DSO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/demo_notebook_08en_chicago.html">Huge-scale simulation using Chicago-Sketch dataset</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../mechanism.html">Simulation Mechanism</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tech_ref.html">Technical Reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Technical Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.World.html">uxsim.World</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.Node.html">uxsim.Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.Link.html">uxsim.Link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.Vehicle.html">uxsim.Vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.RouteChoice.html">uxsim.RouteChoice</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.analyzer.Analyzer.html">uxsim.analyzer.Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.Route.html">uxsim.Route</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.DTAsolvers.SolverDUE.html">uxsim.DTAsolvers.SolverDUE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.DTAsolvers.SolverDSO_D2D.html">uxsim.DTAsolvers.SolverDSO_D2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.TaxiHandler.TripRequest.html">uxsim.TaxiHandler.TripRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.TaxiHandler.TaxiHandler.html">uxsim.TaxiHandler.TaxiHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.TaxiHandler.TaxiHandler_nearest.html">uxsim.TaxiHandler.TaxiHandler_nearest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.OSMImporter2.OSMImporter2.html">uxsim.OSMImporter2.OSMImporter2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.ResultGUIViewer.ResultGUIViewer.html">uxsim.ResultGUIViewer.ResultGUIViewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.uxsim.html">uxsim.uxsim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.utils.html">uxsim.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.scenario_reader_writer.html">uxsim.scenario_reader_writer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.ResultGUIViewer.ResultGUIViewer.html">uxsim.ResultGUIViewer.ResultGUIViewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.TaxiHandler.TaxiHandler.html">uxsim.TaxiHandler.TaxiHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/uxsim.Utilities.Utilities.html">uxsim.Utilities.Utilities</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for uxsim.OSMImporter2.OSMImporter2</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">OpenStreetMap importer using OSMnx and neatnet.</span>
<span class="sd">Work in progress. Import from OSM is experimental and may not work as expected. It is functional but may produce inappropriate networks for simulation, such as too many nodes, too many deadends, fragmented networks.</span>

<span class="sd">Confirmed version: neatnet 0.1.0</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>


<span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#to avoid editor&#39;s failure</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Python 3.11 or higher is required to use &#39;OSMImporter2&#39;.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">osmnx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ox</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Optional module &#39;osmnx&#39; is not installed. Use &#39;pip install uxsim[advanced]&#39;.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">neatnet</span> <span class="c1"># type: ignore</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Optional module &#39;neatnet&#39; is not installed. Use &#39;pip install uxsim[advanced]&#39;. Note that &#39;neatnet&#39; requires Python 3.11 or later.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Optional module &#39;geopandas&#39; is not installed. Use &#39;pip install uxsim[advanced]&#39;.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Optional module &#39;shapely&#39; is not installed. Use &#39;pip install uxsim[advanced]&#39;.&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_obtain_simplify_osm_by_osmnx_neatnet</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">custom_filter</span><span class="p">,</span> <span class="n">simplification</span><span class="p">,</span> <span class="n">kwargs_dict_for_osmnx_graph_from_bbox</span><span class="p">,</span> <span class="n">kwargs_dict_for_osmnx_project_graph</span><span class="p">,</span> <span class="n">kwargs_dict_for_neatnet_neatify</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtains and simplifies OSM data using OSMnx and neatnet libraries. This function retrieves a road network from OpenStreetMap within the specified bounding box, applies projection, and then simplifies the network links using the neatnet library&#39;s neatify algorithm.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bbox : tuple</span>
<span class="sd">        Bounding box coordinates expected by OSMnx.</span>
<span class="sd">    custom_filter : str</span>
<span class="sd">        OSM filter query to use when downloading the network data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GeoDataFrame</span>
<span class="sd">        A GeoDataFrame containing the simplified road network links.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function requires the OSMnx and neatnet libraries to be installed.</span>
<span class="sd">    The returned network is filtered for driving (&quot;drive&quot; network type).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">G</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> <span class="n">network_type</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span><span class="p">,</span> <span class="n">custom_filter</span><span class="o">=</span><span class="n">custom_filter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_dict_for_osmnx_graph_from_bbox</span><span class="p">)</span>
    <span class="n">G_projected</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">project_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_dict_for_osmnx_project_graph</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">simplification</span><span class="p">:</span>
        <span class="n">simplified_links</span> <span class="o">=</span> <span class="n">neatnet</span><span class="o">.</span><span class="n">neatify</span><span class="p">(</span><span class="n">ox</span><span class="o">.</span><span class="n">graph_to_gdfs</span><span class="p">(</span><span class="n">G_projected</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs_dict_for_neatnet_neatify</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">simplified_links</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph_to_gdfs</span><span class="p">(</span><span class="n">G_projected</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">simplified_links</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_network_from_geodataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to extract road network nodes and links from a GeoDataFrame.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    gdf : GeoDataFrame</span>
<span class="sd">        GeoDataFrame containing linear features (LineString)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    nodes_df : GeoDataFrame</span>
<span class="sd">        Node list (node_id, x, y, geometry)</span>
<span class="sd">    links_df : GeoDataFrame</span>
<span class="sd">        Link list (link_id, from_node, to_node, length, and all other columns from the original GeoDataFrame)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># LineStringの形状のみを処理</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">LineString</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;GeoDataFrameにはLineString型のジオメトリのみが含まれている必要があります&quot;</span><span class="p">)</span>
    
    <span class="c1"># ノードの収集（始点と終点）</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_id_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 座標からノードIDへのマッピング</span>
    <span class="n">node_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># リンク情報の収集</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
        
        <span class="c1"># 始点の座標を取得</span>
        <span class="n">start_point</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># 終点の座標を取得</span>
        <span class="n">end_point</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># 始点が既に登録されているかチェック</span>
        <span class="n">start_key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">start_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_id_map</span><span class="p">:</span>
            <span class="n">node_id_map</span><span class="p">[</span><span class="n">start_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_counter</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;node_id&#39;</span><span class="p">:</span> <span class="n">node_counter</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">start_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">start_point</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="n">node_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># 終点が既に登録されているかチェック</span>
        <span class="n">end_key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">end_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_id_map</span><span class="p">:</span>
            <span class="n">node_id_map</span><span class="p">[</span><span class="n">end_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_counter</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;node_id&#39;</span><span class="p">:</span> <span class="n">node_counter</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">end_point</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="n">node_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># リンク情報の作成（元のGeoDataFrameの全カラムを保持）</span>
        <span class="n">link_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;link_id&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
            <span class="s1">&#39;from_node&#39;</span><span class="p">:</span> <span class="n">node_id_map</span><span class="p">[</span><span class="n">start_key</span><span class="p">],</span>
            <span class="s1">&#39;to_node&#39;</span><span class="p">:</span> <span class="n">node_id_map</span><span class="p">[</span><span class="n">end_key</span><span class="p">],</span>
            <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># 元のGeoDataFrameの全カラムをコピー</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;link_id&#39;</span><span class="p">,</span> <span class="s1">&#39;from_node&#39;</span><span class="p">,</span> <span class="s1">&#39;to_node&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]:</span>  <span class="c1"># ジオメトリ等は別途処理するので除外</span>
                <span class="n">link_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                
        <span class="c1"># ジオメトリはリンクデータに追加</span>
        <span class="n">link_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
        
        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link_data</span><span class="p">)</span>
    
    <span class="c1"># ノードとリンクのDataFrameを作成</span>
    <span class="n">nodes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
    
    <span class="c1"># GeoDataFrameに変換</span>
    <span class="n">nodes_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">nodes_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">links_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">links_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">nodes_gdf</span><span class="p">,</span> <span class="n">links_gdf</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_attach_osm_nodes_links</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">set_node_capacity</span><span class="p">,</span> <span class="n">override_osm_attributes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxspeed_by_road_type</span><span class="o">=</span><span class="p">{},</span> <span class="n">lanes_by_road_type</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds OSM nodes and links to the network. This function processes the OSM nodes and links dataframes and adds them to the provided network object (W). For nodes, it extracts coordinates and ID. For links, it processes attributes like speed limits, number of lanes, and handles one-way/two-way streets accordingly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    W : Network object</span>
<span class="sd">        The network object to which nodes and links will be added.</span>
<span class="sd">    nodes : pandas.DataFrame</span>
<span class="sd">        DataFrame containing node information with columns:</span>

<span class="sd">        - node_id: unique identifier for each node</span>
<span class="sd">        - x: x-coordinate</span>
<span class="sd">        - y: y-coordinate</span>

<span class="sd">    links : pandas.DataFrame</span>
<span class="sd">        DataFrame containing link information with columns:</span>

<span class="sd">        - from_node: source node ID</span>
<span class="sd">        - to_node: destination node ID</span>
<span class="sd">        - length: length of the link</span>
<span class="sd">        - maxspeed: maximum speed (km/h)</span>
<span class="sd">        - lanes: number of lanes</span>
<span class="sd">        - name: name of the link</span>
<span class="sd">        - oneway: boolean indicating if the link is one-way</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">maxspeed_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;motorway&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;trunk&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s2">&quot;primary&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;secondary&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s2">&quot;tertiary&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="s2">&quot;residential&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;living_street&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;others&quot;</span><span class="p">:</span> <span class="mi">40</span>
    <span class="p">}</span>
    <span class="n">maxspeed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">maxspeed_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="mf">3.6</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">maxspeed_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">maxspeed_by_road_type</span><span class="p">:</span>
        <span class="n">maxspeed_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxspeed_by_road_type</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">lanes_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;motorway&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;trunk&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;primary&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;secondary&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;tertiary&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;residential&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;living_street&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;others&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lanes_by_road_type</span><span class="p">:</span>
        <span class="n">lanes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lanes_by_road_type</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">added_node_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;node_id&quot;</span><span class="p">])</span>
        <span class="n">W</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">added_node_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">start_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;from_node&quot;</span><span class="p">])</span>
        <span class="n">end_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;to_node&quot;</span><span class="p">])</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="n">highway_type</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;highway&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">highway_type</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#estimate the type from connected links</span>
                <span class="n">from_node</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;from_node&quot;</span><span class="p">]</span>
                <span class="n">links_upstream</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s2">&quot;to_node&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">from_node</span><span class="p">]</span>
                <span class="n">to_node</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;from_node&quot;</span><span class="p">]</span>
                <span class="n">links_downstream</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="n">links</span><span class="p">[</span><span class="s2">&quot;from_node&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">to_node</span><span class="p">]</span>
                
                <span class="n">links_connected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">links_upstream</span><span class="p">[</span><span class="s2">&quot;highway&quot;</span><span class="p">])</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">links_downstream</span><span class="p">[</span><span class="s2">&quot;highway&quot;</span><span class="p">])</span>
                <span class="n">links_connected_filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links_connected</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">links_connected_filtered</span><span class="p">):</span>
                    <span class="n">assumed_type</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">links_connected_filtered</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">assumed_type</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
                
                <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;highway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assumed_type</span>
                <span class="n">highway_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">assumed_type</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">highway_type</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">highway_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">highway_type</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;highway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">highway_type</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">highway_type</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Link </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Could not parse highway_type: </span><span class="si">{</span><span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;highway&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, due to &#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39; error. Using default value of </span><span class="si">{</span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

        <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;maxspeed&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">maxspeed</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override_osm_attributes</span><span class="p">:</span>
                <span class="n">maxspeed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxspeed</span><span class="p">)</span><span class="o">/</span><span class="mf">3.6</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">maxspeed</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override_osm_attributes</span><span class="p">:</span>
                <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">maxspeed</span><span class="p">])</span><span class="o">/</span><span class="mf">3.6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">maxspeed_dict</span><span class="p">[</span><span class="s2">&quot;others&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">maxspeed_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">highway_type</span><span class="p">:</span>
                        <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">maxspeed_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">maxspeed_dict</span><span class="p">[</span><span class="s2">&quot;others&quot;</span><span class="p">]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Link </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Could not parse maxspeed: </span><span class="si">{</span><span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;maxspeed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, due to &#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39; error. Using default value of </span><span class="si">{</span><span class="n">maxspeed_dict</span><span class="p">[</span><span class="s1">&#39;others&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
<span class="w">        </span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        東京の一般道で確認できた範囲では，oneway=Falseの時のlanesは両方向の総和で，oneway=Trueの時のlanesはその方向のみの数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">oneway</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;oneway&quot;</span><span class="p">]</span>
        <span class="n">lanes</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;lanes&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lanes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override_osm_attributes</span><span class="p">:</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lanes</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">lanes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override_osm_attributes</span><span class="p">:</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="n">lanes_dict</span><span class="p">[</span><span class="s2">&quot;others&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lanes_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">highway_type</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">oneway</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">lanes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lanes</span> <span class="o">=</span> <span class="n">lanes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">lanes</span> <span class="o">=</span> <span class="n">lanes_dict</span><span class="p">[</span><span class="s2">&quot;others&quot;</span><span class="p">]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Link </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Could not parse number of lane: </span><span class="si">{</span><span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lanes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, due to &#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39; error. Using default value of </span><span class="si">{</span><span class="n">lanes_dict</span><span class="p">[</span><span class="s1">&#39;others&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">oneway</span><span class="p">:</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="o">=</span><span class="n">end_node</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="n">maxspeed</span><span class="p">,</span> <span class="n">number_of_lanes</span><span class="o">=</span><span class="n">lanes</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lanes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lanes</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lanes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lanes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="o">=</span><span class="n">end_node</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="n">maxspeed</span><span class="p">,</span> <span class="n">number_of_lanes</span><span class="o">=</span><span class="n">lanes</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">W</span><span class="o">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;-reverse&quot;</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="n">end_node</span><span class="p">,</span> <span class="n">end_node</span><span class="o">=</span><span class="n">start_node</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">free_flow_speed</span><span class="o">=</span><span class="n">maxspeed</span><span class="p">,</span> <span class="n">number_of_lanes</span><span class="o">=</span><span class="n">lanes</span><span class="p">,</span> <span class="n">auto_rename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">set_node_capacity</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">W</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">added_node_names</span><span class="p">:</span>
                <span class="n">max_lanes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inlinks</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">outlinks</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                <span class="n">node</span><span class="o">.</span><span class="n">flow_capacity</span> <span class="o">=</span> <span class="n">max_lanes</span><span class="o">*</span><span class="mf">0.8</span><span class="o">*</span><span class="mi">2</span>
                <span class="n">node</span><span class="o">.</span><span class="n">number_of_lanes</span> <span class="o">=</span> <span class="n">max_lanes</span><span class="o">*</span><span class="mi">2</span>


<div class="viewcode-block" id="osm_network_to_World">
<a class="viewcode-back" href="../../../_autosummary/uxsim.OSMImporter2.OSMImporter2.html#uxsim.OSMImporter2.OSMImporter2.osm_network_to_World">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">osm_network_to_World</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">north</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">south</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">east</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">west</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_filter</span><span class="o">=</span><span class="s1">&#39;[&quot;highway&quot;~&quot;trunk|primary&quot;]&#39;</span><span class="p">,</span> 
                         <span class="n">simplification</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">override_osm_attributes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">set_node_capacity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                         <span class="n">maxspeed_by_road_type</span><span class="o">=</span><span class="p">{},</span> <span class="n">lanes_by_road_type</span><span class="o">=</span><span class="p">{},</span> <span class="n">kwargs_dict_for_osmnx_graph_from_bbox</span><span class="o">=</span><span class="p">{},</span> <span class="n">kwargs_dict_for_osmnx_project_graph</span><span class="o">=</span><span class="p">{},</span> <span class="n">kwargs_dict_for_neatnet_neatify</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports OpenStreetMap (OSM) network data into a World object. This function retrieves OSM road network data within the specified bounding box, simplifies the network, and extracts nodes and links using OSMnx and neatnet. Then it attaches them to the World object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    W : World</span>
<span class="sd">        The World object to which the OSM network will be added.</span>
<span class="sd">    north, south, east, west : float, optional</span>
<span class="sd">        The latitudes and longitudes defining the boundaries of the area to be imported.</span>
<span class="sd">    bbox : list, optional</span>
<span class="sd">        The bounding box of the area to be imported. Format is [west, south, east, north].</span>
<span class="sd">        This parameter takes precedence over individual north, south, east, west arguments.</span>
<span class="sd">    custom_filter : str, default=&#39;[&quot;highway&quot;~&quot;trunk|primary&quot;]&#39;</span>
<span class="sd">        The OSM filter to be used for importing the data.</span>
<span class="sd">        Examples:</span>

<span class="sd">        - &#39;[&quot;highway&quot;~&quot;motorway&quot;]&#39;: highways only</span>
<span class="sd">        - &#39;[&quot;highway&quot;~&quot;motorway|trunk|primary|secondary|tertiary&quot;]&#39;: highways and major/mid arterials</span>

<span class="sd">    simplification : bool, default=True</span>
<span class="sd">        If True, the network is simplified using neatnet&#39;s neatify function.</span>
<span class="sd">        If False, the original network is used.</span>
<span class="sd">    override_osm_attributes : bool, default=False</span>
<span class="sd">        If True, the function will override OSM attributes (maxspeed, lanes) with default values. This can be useful when OSM data is erroneous or inconsistent.</span>
<span class="sd">        If False, it will use the attributes from the OSM data.</span>
<span class="sd">    set_node_capacity : bool, default=True</span>
<span class="sd">        If True, automatically determines flow capacity of nodes based on connected links.</span>
<span class="sd">        If False, the capacity is unbounded. This simulates traffic signals in a continuous manner.</span>
<span class="sd">    maxspeed_by_road_type : dict, default={}</span>
<span class="sd">        Dictionary to override default speed limits for different road types.</span>
<span class="sd">    lanes_by_road_type : dict, default={}</span>
<span class="sd">        Dictionary to override default number of lanes for different road types.</span>
<span class="sd">    kwargs_dict_for_osmnx_graph_from_bbox : dict, default={}</span>
<span class="sd">        Additional keyword arguments to pass to OSMnx&#39;s graph.graph_from_bbox function.</span>
<span class="sd">    kwargs_dict_for_osmnx_project_graph : dict, default={}</span>
<span class="sd">        Additional keyword arguments to pass to OSMnx&#39;s project_graph function.</span>
<span class="sd">    kwargs_dict_for_neatnet_neatify : dict, default={}</span>
<span class="sd">        Additional keyword arguments to pass to neatnet&#39;s neatify function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        The function modifies the World object in-place by adding OSM nodes and links.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function performs three main steps:</span>

<span class="sd">    1. Obtains and simplifies the OSM network using OSMnx and neatnet</span>
<span class="sd">    2. Extracts node and link information from the simplified network</span>
<span class="sd">    3. Attaches the extracted nodes and links to the World object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Started network import from OSM. It may take some time...&quot;</span><span class="p">)</span>
    
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Import from OSM is experimental and may not work as expected. It is functional but produces inappropriate networks for simulation, such as too many nodes, too many deadends, fragmented networks.&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">bbox</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="p">[</span><span class="n">west</span><span class="p">,</span><span class="n">south</span><span class="p">,</span><span class="n">east</span><span class="p">,</span><span class="n">north</span><span class="p">]</span>
        
    <span class="n">simplified_links</span> <span class="o">=</span> <span class="n">_obtain_simplify_osm_by_osmnx_neatnet</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">custom_filter</span><span class="p">,</span> <span class="n">simplification</span><span class="p">,</span>
                                                             <span class="n">kwargs_dict_for_osmnx_graph_from_bbox</span><span class="p">,</span> <span class="n">kwargs_dict_for_osmnx_project_graph</span><span class="p">,</span> <span class="n">kwargs_dict_for_neatnet_neatify</span><span class="p">)</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="n">_extract_network_from_geodataframe</span><span class="p">(</span><span class="n">simplified_links</span><span class="p">)</span>  
    <span class="n">_attach_osm_nodes_links</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">set_node_capacity</span><span class="p">,</span> <span class="n">override_osm_attributes</span><span class="o">=</span><span class="n">override_osm_attributes</span><span class="p">,</span> <span class="n">maxspeed_by_road_type</span><span class="o">=</span><span class="n">maxspeed_by_road_type</span><span class="p">,</span> <span class="n">lanes_by_road_type</span><span class="o">=</span><span class="n">lanes_by_road_type</span><span class="p">)</span>

    <span class="n">stats_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">stats_length</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">]</span>
        <span class="n">highway_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;highway&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_link&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">links</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;oneway&quot;</span><span class="p">]:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">stats_count</span><span class="p">[</span><span class="n">highway_type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">*</span><span class="n">coef</span>
        <span class="n">stats_length</span><span class="p">[</span><span class="n">highway_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">length</span><span class="o">*</span><span class="n">coef</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imported </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> nodes and </span><span class="si">{</span><span class="nb">sum</span><span class="p">([</span><span class="n">val</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">stats_count</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="si">}</span><span class="s2"> links from OSM&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stats_count</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; links:</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">stats_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2"> with total length </span><span class="si">{</span><span class="n">stats_length</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span></div>


</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023 Toru Seo
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=5cb08e4e"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    </body>
</html>